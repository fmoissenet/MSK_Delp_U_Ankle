% MAIN PROGRAM
% Main_Muscle_Lines_Visualisation.m
%__________________________________________________________________________
%
% PURPOSE
% Visualisation of muscle lines of action
% Visualisation of bone
%
% SYNOPSIS
% N/A (i.e., main program)
%
% DESCRIPTION
% Plotting of segments, bones and muscle lines of actions
%__________________________________________________________________________
%
% CALLED FUNCTIONS (FROM MUSCULO-SKELETAL TOOLBOX)
%  Mprod_array3.m
%
% MATLAB VERSION
% Matlab R2012a
%__________________________________________________________________________
%
% CHANGELOG
% Created by Raphael Dumas
% April 2018
%
% Modified by Raphael Dumas
% September 2019
% Visualisation of bones
% Plot of contact points
%
% Modified by Raphael Dumas
% March 2020
% Generic vs. Informed structures (Segment, Joint, Model)
% n,f,fc as Model.Informed fields
%__________________________________________________________________________



% Number of frames
n = Model.Informed.n;

% Frames of interest
k = round(n*60/100);

figure
hold on
axis equal

% -------------------------------------------------------------------------
% Interpolation matrices
% Insertion and origin of muscle lines of action
% Plot of bone models
% -------------------------------------------------------------------------

for i = 2:6 % From i = 2 (Foot) to i = 6 (Pelvis)
    
    switch i
        case 2
            indj = 1:15; % 3 first virtual markers are for ankle joint
            Segment(i).Informed.T = Q2Tuv_array3(Segment(i).Informed.Q);
        case 3
            indj = [1:3,6:28]; % 8 first virtual markers are for ankle, tibio-femoral and patello-femoral joints
            % V43 and V53 are alreday available (should not be overwritten)
            Segment(i).Informed.T = Q2Tuv_array3(Segment(i).Informed.Q);
        case 4
            indj = 1:5; % Firt virtual marker is for patello-femoral joint
            Segment(i).Informed.T = Q2Tuv_array3(Segment(i).Informed.Q);
            Segment(i).Informed.T(1:3,4,:) = Segment(i).Informed.Q(7:9,:,:);
        case 5
            indj = 3:43; % 6 first virtual markers are for tibio-femoral joint
            % V43 and V53 are alreday available (should not be overwritten)
            Segment(i).Informed.T = Q2Tuv_array3(Segment(i).Informed.Q);
        case 6
            indj = 1:28; % Firt virtual marker is  for hip joint
            Segment(i).Informed.T = Q2Tuv_array3(Segment(i).Informed.Q);
            Segment(i).Informed.T(1:3,4,:) = Segment(i).Informed.Q(7:9,:,:);
    end
    for j = indj
        % Interpolation matrix
        eval(['NV',num2str(j),num2str(i),...
            '= [Segment(',num2str(i),').Informed.nV(1,',num2str(j),')*eye(3),',...
            '(1 + Segment(',num2str(i),').Informed.nV(2,',num2str(j),'))*eye(3),',...
            '- Segment(',num2str(i),').Informed.nV(2,',num2str(j),')*eye(3),',...
            'Segment(',num2str(i),').Informed.nV(3,',num2str(j),')*eye(3)];']);
        % Point of muscle line of action crossing the joints
        eval(['Segment(',num2str(i),').Informed.rV',num2str(j),num2str(i),...
            '(1:3,1,:) = Mprod_array3(repmat(NV',num2str(j),num2str(i),...
            ',[1,1,n]),Segment(',num2str(i),').Informed.Q);']);
    end
    
    % Scaled vertices in ICS
    Vertices_k = (Segment(i).Informed.T(:,:,k)*...
        [Segment(i).Generic.Vertices*Segment(i).Informed.Scale, ...
        ones(length(Segment(i).Generic.Vertices),1)]')';
    % Plot
    patch('Faces',Segment(i).Generic.Faces,'Vertices',Vertices_k(:,1:3),...
        'FaceColor','k','FaceAlpha', 0.15,'EdgeColor','none');
    
end

% -------------------------------------------------------------------------
% Segments
% -------------------------------------------------------------------------

% Segment 2 'Foot'
plot3([Segment(2).Informed.Q(4,1,k),Segment(2).Informed.Q(7,1,k)],...
    [Segment(2).Informed.Q(5,1,k),Segment(2).Informed.Q(8,1,k)],...
    [Segment(2).Informed.Q(6,1,k),Segment(2).Informed.Q(9,1,k)],'k','linewidth',3);
% Segment 3 'Shank'
plot3([Segment(3).Informed.Q(4,1,k),Segment(3).Informed.Q(7,1,k)],...
    [Segment(3).Informed.Q(5,1,k),Segment(3).Informed.Q(8,1,k)],...
    [Segment(3).Informed.Q(6,1,k),Segment(3).Informed.Q(9,1,k)],'k','linewidth',3);
% Segment 4 'Patella'
plot3([Segment(4).Informed.Q(4,1,k),Segment(4).Informed.Q(7,1,k)],...
    [Segment(4).Informed.Q(5,1,k),Segment(4).Informed.Q(8,1,k)],...
    [Segment(4).Informed.Q(6,1,k),Segment(4).Informed.Q(9,1,k)],'k','linewidth',3);
% Segment 5 'Femur'
plot3([Segment(5).Informed.Q(4,1,k),Segment(5).Informed.Q(7,1,k)],...
    [Segment(5).Informed.Q(5,1,k),Segment(5).Informed.Q(8,1,k)],...
    [Segment(5).Informed.Q(6,1,k),Segment(5).Informed.Q(9,1,k)],'k','linewidth',3);
% Segment 6 'Pelvis'
plot3([Segment(6).Informed.Q(4,1,k),Segment(6).Informed.Q(7,1,k)],...
    [Segment(6).Informed.Q(5,1,k),Segment(6).Informed.Q(8,1,k)],...
    [Segment(6).Informed.Q(6,1,k),Segment(6).Informed.Q(9,1,k)],'k','linewidth',3);

% -------------------------------------------------------------------------
% Muscle lines of action
% -------------------------------------------------------------------------

% Gluteus maximus I
plot3([Segment(6).Informed.rV26(1,1,k),Segment(5).Informed.rV75(1,1,k)],...
    [Segment(6).Informed.rV26(2,1,k),Segment(5).Informed.rV75(2,1,k)],...
    [Segment(6).Informed.rV26(3,1,k),Segment(5).Informed.rV75(3,1,k)],'r','linewidth',2);
% Gluteus maximus II
plot3([Segment(6).Informed.rV36(1,1,k),Segment(5).Informed.rV85(1,1,k)],...
    [Segment(6).Informed.rV36(2,1,k),Segment(5).Informed.rV85(2,1,k)],...
    [Segment(6).Informed.rV36(3,1,k),Segment(5).Informed.rV85(3,1,k)],'r','linewidth',2);
% Gluteus maximus III
plot3([Segment(6).Informed.rV46(1,1,k),Segment(5).Informed.rV95(1,1,k)],...
    [Segment(6).Informed.rV46(2,1,k),Segment(5).Informed.rV95(2,1,k)],...
    [Segment(6).Informed.rV46(3,1,k),Segment(5).Informed.rV95(3,1,k)],'r','linewidth',2);
% Gluteus medius I
plot3([Segment(6).Informed.rV56(1,1,k),Segment(5).Informed.rV105(1,1,k)],...
    [Segment(6).Informed.rV56(2,1,k),Segment(5).Informed.rV105(2,1,k)],...
    [Segment(6).Informed.rV56(3,1,k),Segment(5).Informed.rV105(3,1,k)],'r','linewidth',2);
% Gluteus medius II
plot3([Segment(6).Informed.rV66(1,1,k),Segment(5).Informed.rV115(1,1,k)],...
    [Segment(6).Informed.rV66(2,1,k),Segment(5).Informed.rV115(2,1,k)],...
    [Segment(6).Informed.rV66(3,1,k),Segment(5).Informed.rV115(3,1,k)],'r','linewidth',2);
% Gluteus medius III
plot3([Segment(6).Informed.rV76(1,1,k),Segment(5).Informed.rV125(1,1,k)],...
    [Segment(6).Informed.rV76(2,1,k),Segment(5).Informed.rV125(2,1,k)],...
    [Segment(6).Informed.rV76(3,1,k),Segment(5).Informed.rV125(3,1,k)],'r','linewidth',2);
% Gluteus minimus I
plot3([Segment(6).Informed.rV86(1,1,k),Segment(5).Informed.rV135(1,1,k)],...
    [Segment(6).Informed.rV86(2,1,k),Segment(5).Informed.rV135(2,1,k)],...
    [Segment(6).Informed.rV86(3,1,k),Segment(5).Informed.rV135(3,1,k)],'r','linewidth',2);
% Gluteus minimus II
plot3([Segment(6).Informed.rV96(1,1,k),Segment(5).Informed.rV145(1,1,k)],...
    [Segment(6).Informed.rV96(2,1,k),Segment(5).Informed.rV145(2,1,k)],...
    [Segment(6).Informed.rV96(3,1,k),Segment(5).Informed.rV145(3,1,k)],'r','linewidth',2);
% Gluteus minimus III
plot3([Segment(6).Informed.rV106(1,1,k),Segment(5).Informed.rV155(1,1,k)],...
    [Segment(6).Informed.rV106(2,1,k),Segment(5).Informed.rV155(2,1,k)],...
    [Segment(6).Informed.rV106(3,1,k),Segment(5).Informed.rV155(3,1,k)],'r','linewidth',2);
% Adductor longus
plot3([Segment(6).Informed.rV116(1,1,k),Segment(5).Informed.rV165(1,1,k)],...
    [Segment(6).Informed.rV116(2,1,k),Segment(5).Informed.rV165(2,1,k)],...
    [Segment(6).Informed.rV116(3,1,k),Segment(5).Informed.rV165(3,1,k)],'r','linewidth',2);
% Adductor brevis
plot3([Segment(6).Informed.rV126(1,1,k),Segment(5).Informed.rV175(1,1,k)],...
    [Segment(6).Informed.rV126(2,1,k),Segment(5).Informed.rV175(2,1,k)],...
    [Segment(6).Informed.rV126(3,1,k),Segment(5).Informed.rV175(3,1,k)],'r','linewidth',2);
% Adductor magnus I
plot3([Segment(6).Informed.rV136(1,1,k),Segment(5).Informed.rV185(1,1,k)],...
    [Segment(6).Informed.rV136(2,1,k),Segment(5).Informed.rV185(2,1,k)],...
    [Segment(6).Informed.rV136(3,1,k),Segment(5).Informed.rV185(3,1,k)],'r','linewidth',2);
% Adductor magnus II
plot3([Segment(6).Informed.rV146(1,1,k),Segment(5).Informed.rV195(1,1,k)],...
    [Segment(6).Informed.rV146(2,1,k),Segment(5).Informed.rV195(2,1,k)],...
    [Segment(6).Informed.rV146(3,1,k),Segment(5).Informed.rV195(3,1,k)],'r','linewidth',2);
% Adductor magnus III
plot3([Segment(6).Informed.rV156(1,1,k),Segment(5).Informed.rV205(1,1,k)],...
    [Segment(6).Informed.rV156(2,1,k),Segment(5).Informed.rV205(2,1,k)],...
    [Segment(6).Informed.rV156(3,1,k),Segment(5).Informed.rV205(3,1,k)],'r','linewidth',2);
% Pectineus
plot3([Segment(6).Informed.rV166(1,1,k),Segment(5).Informed.rV215(1,1,k)]...
    ,[Segment(6).Informed.rV166(2,1,k),Segment(5).Informed.rV215(2,1,k)],...
    [Segment(6).Informed.rV166(3,1,k),Segment(5).Informed.rV215(3,1,k)],'r','linewidth',2);
% Illiacus
plot3([Segment(6).Informed.rV176(1,1,k),Segment(5).Informed.rV225(1,1,k)],...
    [Segment(6).Informed.rV176(2,1,k),Segment(5).Informed.rV225(2,1,k)],...
    [Segment(6).Informed.rV176(3,1,k),Segment(5).Informed.rV225(3,1,k)],'r','linewidth',2);
% Psoas
plot3([Segment(6).Informed.rV186(1,1,k),Segment(5).Informed.rV235(1,1,k)],...
    [Segment(6).Informed.rV186(2,1,k),Segment(5).Informed.rV235(2,1,k)],...
    [Segment(6).Informed.rV186(3,1,k),Segment(5).Informed.rV235(3,1,k)],'r','linewidth',2);
% Quadratus femoris
plot3([Segment(6).Informed.rV196(1,1,k),Segment(5).Informed.rV245(1,1,k)],...
    [Segment(6).Informed.rV196(2,1,k),Segment(5).Informed.rV245(2,1,k)],...
    [Segment(6).Informed.rV196(3,1,k),Segment(5).Informed.rV245(3,1,k)],'r','linewidth',2);
% Gemellus
plot3([Segment(6).Informed.rV206(1,1,k),Segment(5).Informed.rV255(1,1,k)],...
    [Segment(6).Informed.rV206(2,1,k),Segment(5).Informed.rV255(2,1,k)],...
    [Segment(6).Informed.rV206(3,1,k),Segment(5).Informed.rV255(3,1,k)],'r','linewidth',2);
% Piriformis
plot3([Segment(6).Informed.rV216(1,1,k),Segment(5).Informed.rV265(1,1,k)],...
    [Segment(6).Informed.rV216(2,1,k),Segment(5).Informed.rV265(2,1,k)],...
    [Segment(6).Informed.rV216(3,1,k),Segment(5).Informed.rV265(3,1,k)],'r','linewidth',2);
% Tensor fasciae latae
plot3([Segment(6).Informed.rV226(1,1,k),Segment(5).Informed.rV275(1,1,k),Segment(5).Informed.rV285(1,1,k),Segment(3).Informed.rV103(1,1,k)],...
    [Segment(6).Informed.rV226(2,1,k),Segment(5).Informed.rV275(2,1,k),Segment(5).Informed.rV285(2,1,k),Segment(3).Informed.rV103(2,1,k)],...
    [Segment(6).Informed.rV226(3,1,k),Segment(5).Informed.rV275(3,1,k),Segment(5).Informed.rV285(3,1,k),Segment(3).Informed.rV103(3,1,k)],'r','linewidth',2);
% Gracilis
plot3([Segment(6).Informed.rV236(1,1,k),Segment(3).Informed.rV113(1,1,k)],...
    [Segment(6).Informed.rV236(2,1,k),Segment(3).Informed.rV113(2,1,k)],...
    [Segment(6).Informed.rV236(3,1,k),Segment(3).Informed.rV113(3,1,k)],'r','linewidth',2);
% Sartorius
plot3([Segment(6).Informed.rV276(1,1,k),Segment(5).Informed.rV295(1,1,k),Segment(3).Informed.rV153(1,1,k)],...
    [Segment(6).Informed.rV276(2,1,k),Segment(5).Informed.rV295(2,1,k),Segment(3).Informed.rV153(2,1,k)],...
    [Segment(6).Informed.rV276(3,1,k),Segment(5).Informed.rV295(3,1,k),Segment(3).Informed.rV153(3,1,k)],'r','linewidth',2);
% Semimenbranosus
plot3([Segment(6).Informed.rV246(1,1,k),Segment(3).Informed.rV123(1,1,k)],...
    [Segment(6).Informed.rV246(2,1,k),Segment(3).Informed.rV123(2,1,k)],...
    [Segment(6).Informed.rV246(3,1,k),Segment(3).Informed.rV123(3,1,k)],'r','linewidth',2);
% Semitendinosus
plot3([Segment(6).Informed.rV256(1,1,k),Segment(3).Informed.rV133(1,1,k)],...
    [Segment(6).Informed.rV256(2,1,k),Segment(3).Informed.rV133(2,1,k)],...
    [Segment(6).Informed.rV256(3,1,k),Segment(3).Informed.rV133(3,1,k)],'r','linewidth',2);
% Biceps femoris long head
plot3([Segment(6).Informed.rV266(1,1,k),Segment(3).Informed.rV143(1,1,k)],...
    [Segment(6).Informed.rV266(2,1,k),Segment(3).Informed.rV143(2,1,k)],...
    [Segment(6).Informed.rV266(3,1,k),Segment(3).Informed.rV143(3,1,k)],'r','linewidth',2);
% Biceps femoris short head
plot3([Segment(5).Informed.rV305(1,1,k),Segment(3).Informed.rV163(1,1,k)],...
    [Segment(5).Informed.rV305(2,1,k),Segment(3).Informed.rV163(2,1,k)],...
    [Segment(5).Informed.rV305(3,1,k),Segment(3).Informed.rV163(3,1,k)],'r','linewidth',2);
% Rectus femoris (in case of tibio-femoral angle > - 83.65 degrees)
plot3([Segment(6).Informed.rV286(1,1,k),Segment(4).Informed.rV24(1,1,k)],...
    [Segment(6).Informed.rV286(2,1,k),Segment(4).Informed.rV24(2,1,k)],...
    [Segment(6).Informed.rV286(3,1,k),Segment(4).Informed.rV24(3,1,k)],'r','linewidth',2);
% Vastus medialis (in case of tibio-femoral angle > -69.32 degrees)
plot3([Segment(5).Informed.rV325(1,1,k),Segment(4).Informed.rV34(1,1,k)],...
    [Segment(5).Informed.rV325(2,1,k),Segment(4).Informed.rV34(2,1,k)],...
    [Segment(5).Informed.rV325(3,1,k),Segment(4).Informed.rV34(3,1,k)],'r','linewidth',2);
% Vastus intermedialis (in case of tibio-femoral angle > - -81.36 degrees)
plot3([Segment(5).Informed.rV355(1,1,k),Segment(4).Informed.rV44(1,1,k)],...
    [Segment(5).Informed.rV355(2,1,k),Segment(4).Informed.rV44(2,1,k)],...
    [Segment(5).Informed.rV355(3,1,k),Segment(4).Informed.rV44(3,1,k)],'r','linewidth',2);
% Vastus lateralis (in case of tibio-femoral angle > -69.32 degrees)
plot3([Segment(5).Informed.rV375(1,1,k),Segment(4).Informed.rV54(1,1,k)],...
    [Segment(5).Informed.rV375(2,1,k),Segment(4).Informed.rV54(2,1,k)],...
    [Segment(5).Informed.rV375(3,1,k),Segment(4).Informed.rV54(3,1,k)],'r','linewidth',2);
% Gastrocnemius medialis (in case of tibio-femoral angle > -44.12 degrees)
plot3([Segment(5).Informed.rV405(1,1,k),Segment(3).Informed.rV173(1,1,k),Segment(2).Informed.rV42(1,1,k)],...
    [Segment(5).Informed.rV405(2,1,k),Segment(3).Informed.rV173(2,1,k),Segment(2).Informed.rV42(2,1,k)],...
    [Segment(5).Informed.rV405(3,1,k),Segment(3).Informed.rV173(3,1,k),Segment(2).Informed.rV42(3,1,k)],'r','linewidth',2);
% Gastrocnemius lateralis (in case of tibio-femoral angle > -44.12 degrees)
plot3([Segment(5).Informed.rV425(1,1,k),Segment(3).Informed.rV183(1,1,k),Segment(2).Informed.rV52(1,1,k)],...
    [Segment(5).Informed.rV425(2,1,k),Segment(3).Informed.rV183(2,1,k),Segment(2).Informed.rV52(2,1,k)],...
    [Segment(5).Informed.rV425(3,1,k),Segment(3).Informed.rV183(3,1,k),Segment(2).Informed.rV52(3,1,k)],'r','linewidth',2);
% Soleus
plot3([Segment(3).Informed.rV193(1,1,k),Segment(2).Informed.rV62(1,1,k)],...
    [Segment(3).Informed.rV193(2,1,k),Segment(2).Informed.rV62(2,1,k)],...
    [Segment(3).Informed.rV193(3,1,k),Segment(2).Informed.rV62(3,1,k)],'r','linewidth',2);
% Tibialis posterior
plot3([Segment(3).Informed.rV203(1,1,k),Segment(2).Informed.rV72(1,1,k)],...
    [Segment(3).Informed.rV203(2,1,k),Segment(2).Informed.rV72(2,1,k)],...
    [Segment(3).Informed.rV203(3,1,k),Segment(2).Informed.rV72(3,1,k)],'r','linewidth',2);
% Tibialis anterior
plot3([Segment(3).Informed.rV213(1,1,k),Segment(2).Informed.rV82(1,1,k)],...
    [Segment(3).Informed.rV213(2,1,k),Segment(2).Informed.rV82(2,1,k)],...
    [Segment(3).Informed.rV213(3,1,k),Segment(2).Informed.rV82(3,1,k)],'r','linewidth',2);
% Peroneus brevis
plot3([Segment(3).Informed.rV223(1,1,k),Segment(2).Informed.rV92(1,1,k)],...
    [Segment(3).Informed.rV223(2,1,k),Segment(2).Informed.rV92(2,1,k)],...
    [Segment(3).Informed.rV223(3,1,k),Segment(2).Informed.rV92(3,1,k)],'r','linewidth',2);
% Peroneus longus
plot3([Segment(3).Informed.rV233(1,1,k),Segment(2).Informed.rV102(1,1,k)],...
    [Segment(3).Informed.rV233(2,1,k),Segment(2).Informed.rV102(2,1,k)],...
    [Segment(3).Informed.rV233(3,1,k),Segment(2).Informed.rV102(3,1,k)],'r','linewidth',2);
% Peroneus tertius
plot3([Segment(3).Informed.rV243(1,1,k),Segment(2).Informed.rV112(1,1,k)],...
    [Segment(3).Informed.rV243(2,1,k),Segment(2).Informed.rV112(2,1,k)],...
    [Segment(3).Informed.rV243(3,1,k),Segment(2).Informed.rV112(3,1,k)],'r','linewidth',2);
% Extensor digitorum longus
plot3([Segment(3).Informed.rV253(1,1,k),Segment(2).Informed.rV122(1,1,k)],...
    [Segment(3).Informed.rV253(2,1,k),Segment(2).Informed.rV122(2,1,k)],...
    [Segment(3).Informed.rV253(3,1,k),Segment(2).Informed.rV122(3,1,k)],'r','linewidth',2);
% Extensor hallucis longus
plot3([Segment(3).Informed.rV263(1,1,k),Segment(2).Informed.rV132(1,1,k)],...
    [Segment(3).Informed.rV263(2,1,k),Segment(2).Informed.rV132(2,1,k)],...
    [Segment(3).Informed.rV263(3,1,k),Segment(2).Informed.rV132(3,1,k)],'r','linewidth',2);
% Flexor digitorum longus
plot3([Segment(3).Informed.rV273(1,1,k),Segment(2).Informed.rV142(1,1,k)],...
    [Segment(3).Informed.rV273(2,1,k),Segment(2).Informed.rV142(2,1,k)],...
    [Segment(3).Informed.rV273(3,1,k),Segment(2).Informed.rV142(3,1,k)],'r','linewidth',2);
% Flexor hallucis longus
plot3([Segment(3).Informed.rV283(1,1,k),Segment(2).Informed.rV152(1,1,k)],...
    [Segment(3).Informed.rV283(2,1,k),Segment(2).Informed.rV152(2,1,k)],...
    [Segment(3).Informed.rV283(3,1,k),Segment(2).Informed.rV152(3,1,k)],'r','linewidth',2);


legend({'Foot', 'Tibia', 'Patella', 'Femur', 'Pelvis' ...
    'Foot','Shank','Patella','Femur','Pelvis', ...
    'Gluteus maximus I', 'Gluteus maximus II', 'Gluteus maximus III', ...
    'Gluteus medius I', 'Gluteus medius II', 'Gluteus medius III', ...
    'Gluteus minimus I', 'Gluteus minimus II', 'Gluteus minimus III', ...
    'Adductor longus', 'Adductor brevis', ...
    'Adductor magnus I', 'Adductor magnus II', 'Adductor magnus III', ...
    'Pectineus', 'Illiacus', 'Psoas', ...
    'Quadratus femoris', 'Gemelli', ...
    'Piriformis','Tensor fasciae latae', ...
    'Gracilis', 'Sartorius', 'Semimembranosus', ...
    'Semitendinus', 'Biceps femoris long head', ...
    'Biceps femoris short head', 'Rectus femoris', ...
    'Vastus medialis', 'Vastus intermedialis', 'Vastus lateralis', ...
    'Gastrocnemius medialis', 'Gastrocnemius lateralis', ...
    'Soleus', 'Tibialis posterior', 'Tibialis anterior', ...
    'Peroneus brevis', 'Peroneus longus', 'Peroneus tertius', ...
    'Extensor digitorum longus', 'Extensor hallucis longus', ...
    'Flexor digitorum longus', 'Flexor hallucis longus'})

% -------------------------------------------------------------------------
% Joints
% -------------------------------------------------------------------------

% Contact points
plot3(Segment(3).Informed.rV43(1,1,k),Segment(3).Informed.rV43(2,1,k),Segment(3).Informed.rV43(3,1,k),'ob');
plot3(Segment(3).Informed.rV53(1,1,k),Segment(3).Informed.rV53(2,1,k),Segment(3).Informed.rV53(3,1,k),'ob');

% Patellofemoral axis point
plot3(Segment(5).Informed.rV65(1,1,k),Segment(5).Informed.rV65(2,1,k),Segment(5).Informed.rV65(3,1,k),'ob');
% Patellofemoral tendon
plot3([Segment(3).Informed.rV93(1,1,k),Segment(4).Informed.Q(7,1,k)],...
    [Segment(3).Informed.rV93(2,1,k),Segment(4).Informed.Q(8,1,k)],...
    [Segment(3).Informed.rV93(3,1,k),Segment(4).Informed.Q(9,1,k)],'b','linewidth',2);
quiver3(Segment(4).Informed.rV14(1,1,k),Segment(4).Informed.rV14(2,1,k),Segment(4).Informed.rV14(3,1,k), ...
    Segment(4).Informed.n14(1,1,k)*0.1,Segment(4).Informed.n14(2,1,k)*0.1,Segment(4).Informed.n14(3,1,k)*0.1,0,'b');


% Midpoint between between ankle axis and subtalar axis (universal joint for ankle)
plot3(Segment(2).Informed.rV12(1,1,k),Segment(2).Informed.rV12(2,1,k),Segment(2).Informed.rV12(3,1,k),'ob');
plot3(Segment(3).Informed.rV13(1,1,k),Segment(3).Informed.rV13(2,1,k),Segment(3).Informed.rV13(3,1,k),'ob');
quiver3(Segment(2).Informed.rV12(1,1,k),Segment(2).Informed.rV12(2,1,k),Segment(2).Informed.rV12(3,1,k), ...
    Segment(2).Informed.n12(1,1,k)*0.1,Segment(2).Informed.n12(2,1,k)*0.1,Segment(2).Informed.n12(3,1,k)*0.1,0,'b');
quiver3(Segment(3).Informed.rV13(1,1,k),Segment(3).Informed.rV13(2,1,k),Segment(3).Informed.rV13(3,1,k), ...
    Segment(3).Informed.n13(1,1,k)*0.1,Segment(3).Informed.n13(2,1,k)*0.1,Segment(3).Informed.n13(3,1,k)*0.1,0,'b');

% Real markers
for i = [2,3,5,6]
    for j = 1:size(Segment(i).Informed.rM,2)
        plot3(permute(Segment(i).Informed.rM(1,j,k),[3,2,1]),...
            permute(Segment(i).Informed.rM(2,j,k),[3,2,1]),...
            permute(Segment(i).Informed.rM(3,j,k),[3,2,1]),'ok');
    end
end

% Informed virtual markers
rMij = []; % Initialisation
for i = [2,3,5,6]
    for j = 1:size(Segment(i).Informed.nM,2)
        NMij = [Segment(i).Informed.nM(1,j)*eye(3),...
                (1 + Segment(i).Informed.nM(2,j))*eye(3), ...
                - Segment(i).Informed.nM(2,j)*eye(3), ...
                Segment(i).Informed.nM(3,j)*eye(3)];
        rMij(:,j,k) = NMij*Segment(i).Informed.Q(:,:,k);
        plot3(permute(rMij(1,j,k),[3,2,1]),...
            permute(rMij(2,j,k),[3,2,1]),...
            permute(rMij(3,j,k),[3,2,1]),'dm');
    end
end

% Scaled generic virtual markers
rMij = []; % Initialisation
for i = [2,3,5,6]
    for j = 1:size(Segment(i).Generic.rMs,2)
        rMij(:,j,k) = ... % Overwrite
            Segment(i).Informed.T(:,:,k)*...
            [Segment(i).Generic.rMs(:,j)*Segment(i).Informed.Scale;1];
        plot3(permute(rMij(1,j,k),[3,2,1]),...
            permute(rMij(2,j,k),[3,2,1]),...
            permute(rMij(3,j,k),[3,2,1]),'sc');
    end
end

