% FUNCTION
% Compute_L_Hill.m
%__________________________________________________________________________
%
% PURPOSE
% Computation of the generalised muscle lever arms
%
% SYNOPSIS
% (Segment,Model) = Compute_L_Hill(Segment,Model)
%
% INPUT
% Segment (cf. data structure in user guide)
% Model (cf. data structure in user guide)
%
% OUTPUT
% Segment (cf. data structure in user guide)
% Model (cf. data structure in user guide)
%
% DESCRIPTION
% Definition of the virtuels markers for origin, via and insertion of
% muscles and computation of the lever arms
%
% REFERENCES
%__________________________________________________________________________
%
% CALLED FUNCTIONS (FROM MUSCULO-SKELETAL TOOLBOX)
% Mprod_array3.m
% Vnorm_array3.m
%
% MATLAB VERSION
% Matlab R2012a
%__________________________________________________________________________
%
% CHANGELOG
% Created by Raphaël Dumas, Florent Moissent, Edouard Jouan
% September 2012
%
% Modified by Raphaël Dumas
% May 2016
% Insertion of semimembranosus: [-0.0243;-0.0536;-0.0194] (it was 0.0243 not -0.0243)
% Insertion of rectus femoris: [ 0.0121; 0.0437;-0.0010] (it was 0.043 not 0.0437)
% Via point of gastrocnemius lateralis: [-0.0242;-0.0481; 0.0235] (it was 0.0295 not 0.0235)
%
% Modified by Raphaël Dumas
% January 2018
% Scaled by homothety of centre = nearest joint centre
% Pelvis scaled by femur ratio
%
% Modified by Raphaël Dumas
% March 2018
% Translation from malleoli to talus added to calcaneus insertions
% Consitent scaling ratio for shank segment
% Correction of a sign error in gastrocnemius lateralis (when via point V435 is used)
%
% Modified by Raphaël Dumas
% April 2018
% Use of eval to compute interpolation matrices

% Modified by Raphaël Dumas
% September 2019
% Joint(3).Euler = R2mobileZXY_array3... (it was R2mobileZYX_array3)
% Shank length based on mid-maleolli (model virtual markers): 0.3994
% Thigh length based on mid-epicondyle (model virtual markers): 0.4040
%
% Modified by Raphaël Dumas
% October 2019
% Possibility of scaling using segment width 
% Shank width based on maleolli (bone vertices closed to virtual markers): 0.0761
% Thigh width based on epicondyles (virtual markers projected on bone model): 0.0786
%
% Modified by Raphael Dumas
% January 2020
% Shank length = 0.3914 form mid-epicondyle to mid-malleolus
% From Delp mechanism to mid-epicondyle: [0.00525; 0.4040 - 0.3960; 0]
% Foot model scaled by foot length (0.1481)
%
% Modified by Florent Moissenet
% March 2020
% Scaling set by Segment(i).rScale
%__________________________________________________________________________

function [Segment,Model] = Compute_L_Hill(Segment,Model)

% Number of frames
n = size(Segment(2).rM,3);

% -------------------------------------------------------------------------
% Virtual markers
% Coordinates in (ui, rPi-rDi, wi)
% -------------------------------------------------------------------------
       
% Foot (i = 2)
% Virtual markers start at 4 (others are for ankle joint)
% Original insertions expressed in calcaneum coordinate system
% SCS centre relocalised at mid-malleolii (rP2) 
% Scaled by an homothety of centre (rP2)
Segment(2).nV(:,4)  = inv(Segment(2).B) * ...
    ([0.00440000; 0.03100000; -0.00530000] ... % Insertion of gastrocnemius medialis
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,5)  = inv(Segment(2).B) * ...
    ([0.00440000; 0.03100000; -0.00530000] ... % Insertion of gastrocnemius lateralis
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,6)  = inv(Segment(2).B) * ...
    ([0.00440000; 0.03100000; -0.00530000] ... % Insertion of soleus
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,7)  = inv(Segment(2).B) * ...
    ([0.04170000; 0.03340000; -0.02860000] ... % Via point of tibialis posterior (considered as insertion)
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,8)  = inv(Segment(2).B) * ...
    ([0.11660000; 0.01780000; -0.03050000] ... % Insertion of tibialis anterior
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,9)  = inv(Segment(2).B) * ...
    ([0.04710000; 0.02700000; 0.02330000] ... % Via point of peroneus brevis (considered as insertion)
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,10) = inv(Segment(2).B) * ...
    ([0.04380000; 0.02300000; 0.02210000] ... % Via point of peroneus longus (considered as insertion)
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,11) = inv(Segment(2).B) * ...
    ([0.08570000; 0.02280000; 0.02990000] ... % Insertion of peroneus tertius
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,12) = inv(Segment(2).B) * ...
    ([0.09220000; 0.03880000; -0.00010000] ... % Via point of extensor digitorum longus (considered as insertion)
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,13) = inv(Segment(2).B) * ...
    ([0.09700000; 0.03890000; -0.02110000] ... % Via point of extensor hallucis longus (considered as insertion)
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;
Segment(2).nV(:,14) = inv(Segment(2).B) * ...
    ([0.04360000; 0.03150000; -0.02800000] ... % Via point of flexor digitorum longus (considered as insertion)
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(3).rScale;
Segment(2).nV(:,15) = inv(Segment(2).B) * ...
    ([0.03740000; 0.02760000; -0.02410000] ... % Via point of flexor hallucis longus (considered as insertion)
    + Model.geometry.T_calca_talus + Model.geometry.T_talus_tibia + Model.geometry.T_tibia_mmall) * ...
    Segment(2).rScale;

% Shank (i = 3)
% Virtual markers start at 10 (others are for ankle, tibio-femoral and patello-femoral joints)
% 
% Muscle points close to knee joint are scaled by thigh (i = 5) geometry
% Original insertions expressed in tibia coordinate system
% SCS centre relocalised at mid-epicondyles (rP3)
% Scaled by an homothety of centre (rP3)
Segment(3).nV(:,10) = inv(Segment(3).B) * ...
    ([0.0060;-0.0487; 0.0297] ... % Insertion of tensor fasciae latae
    + Model.geometry.T_tibia_mepic) ...
    *Segment(5).rScale;
Segment(3).nV(:,11) = inv(Segment(3).B) * ...
    ([-0.0154;-0.0475;-0.0358] ... % Via point of gracillis (considered as insertion)
    + Model.geometry.T_tibia_mepic) ...
    *Segment(5).rScale;
Segment(3).nV(:,12) = inv(Segment(3).B) * ...
    ([-0.0243;-0.0536;-0.0194] ... % Insertion of semimembranosus
    + Model.geometry.T_tibia_mepic) ...
    *Segment(5).rScale;
Segment(3).nV(:,13) = inv(Segment(3).B) * ...
    ([-0.0314;-0.0545;-0.0146] ... % Via point of semitendinus (considered as insertion)
    + Model.geometry.T_tibia_mepic) ...
    *Segment(5).rScale;
Segment(3).nV(:,14) = inv(Segment(3).B) * ...
    ([-0.0081;-0.0729; 0.0423] ... % Insertion of biceps femoris long head
    + Model.geometry.T_tibia_mepic) ...
    *Segment(5).rScale;
Segment(3).nV(:,15) = inv(Segment(3).B) * ...
    ([-0.0056;-0.0419;-0.0399] ... % Via point of sartorius (considered as insertion)
    + Model.geometry.T_tibia_mepic) ...
    *Segment(5).rScale;
Segment(3).nV(:,16) = inv(Segment(3).B) * ...
    ([-0.0101;-0.0725; 0.0406] ... % Insertion of biceps femoris short head
    + Model.geometry.T_tibia_mepic) ...
    *Segment(5).rScale;
Segment(3).nV(:,17) = inv(Segment(3).B) * ...
    ([-0.0217;-0.0487;-0.0295] ... % Via point of gastrocnemius medialis
    + Model.geometry.T_tibia_mepic) ...
    *Segment(5).rScale;
Segment(3).nV(:,18) = inv(Segment(3).B) * ...
    ([-0.0242;-0.0481; 0.0235] ... % Via point of gastrocnemius lateralis
    + Model.geometry.T_tibia_mepic) ...
    *Segment(5).rScale;
%
% Other muscle points scaled by shank (i = 3) geometry
% Original insertions expressed in tibia coordinate system (center near knee joint centre)
% SCS centre relocalised at mid-malleolii (rD3)
% Scaled by an homothety of centre (rD3)
Segment(3).nV(:,19) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([-0.0024; -0.1533; 0.0071] ... % Origin of soleus
    + Model.geometry.T_tibia_mmall) ... 
    *Segment(3).rScale;
Segment(3).nV(:,20) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([-0.0144;-0.4051;-0.0229] ... % Via point of tibialis posterior (considered as origin)
    + Model.geometry.T_tibia_mmall) ...
    * Segment(3).rScale;
Segment(3).nV(:,21) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([0.0329;-0.3951;-0.0177] ... % Via point of tibialis anterior (considered as origin)
    + Model.geometry.T_tibia_mmall) ...
    * Segment(3).rScale;
Segment(3).nV(:,22) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([-0.0144;-0.4295; 0.0289] ... % Via point of peroneus brevis (considered as origin)
    + Model.geometry.T_tibia_mmall) ...
    * Segment(3).rScale;
Segment(3).nV(:,23) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([-0.0162;-0.4319; 0.0289] ... % Via point of peroneus longus (considered as origin)
    + Model.geometry.T_tibia_mmall) ...
    * Segment(3).rScale;
Segment(3).nV(:,24) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([0.0229;-0.4069; 0.0159] ... % Via point of peroneus tertius (considered as origin)
    + Model.geometry.T_tibia_mmall) ...
    * Segment(3).rScale;
Segment(3).nV(:,25) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([0.0289;-0.4007; 0.0072] ... % Via point of extensor digitorum longus (considered as origin)
    + Model.geometry.T_tibia_mmall) ...
    * Segment(3).rScale;
Segment(3).nV(:,26) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([0.0326;-0.3985;-0.0085] ... % Via point of extensor hallucis longus (considered as origin)
    + Model.geometry.T_tibia_mmall) ...
    * Segment(3).rScale;
Segment(3).nV(:,27) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([-0.0154;-0.4051;-0.0196] ... % Via point of flexor digitorum longus (considered as origin)
    + Model.geometry.T_tibia_mmall) ...
    * Segment(3).rScale;
Segment(3).nV(:,28) = [0; -1; 0] + inv(Segment(3).B) * ...
    ([-0.0186;-0.4079;-0.0174] ... % Via point of flexor hallucis longus (considered as origin)
    + Model.geometry.T_tibia_mmall) ...
    * Segment(3).rScale;

% Patella (i = 4)
% Virtual markers start at 2 (other is for patello-femoral joint)
% Original insertions expressed in patella coordinate system (center at rD4)
% Scaled by an homothety of centre (rD4)
Segment(4).nV(:,2) = [0; -1; 0] + inv(Segment(4).B) * ...
    [0.0121; 0.0437;-0.0010] * ... % Insertion of rectus femoris
    Segment(4).rScale; 
Segment(4).nV(:,3) = [0; -1; 0] + inv(Segment(4).B) * ...
    [0.0063; 0.0445;-0.0170] * ... % Insertion of vastus medialis
    Segment(4).rScale; 
Segment(4).nV(:,4) = [0; -1; 0] + inv(Segment(4).B) * ...
    [0.0058; 0.0480;-0.0006] * ... % Insertion of vastus intermedialis
    Segment(4).rScale; 
Segment(4).nV(:,5) = [0; -1; 0] + inv(Segment(4).B) * ...
    [0.0103; 0.0423; 0.0141] * ... % Insertion of vastus lateralis
    Segment(4).rScale; 
    
% Thigh (i = 5)
% Virtual markers start at 7 (others are for tibio-femoral joint)
%
% Muscle points close to hip joint scaled by pelvis (i = 6) geometry
% Original insertions expressed in femur coordinate system (centre at rP5)
% Scaled by an homothety of centre (rP5)
Segment(5).nV(:,7)  = inv(Segment(5).B) * ...
    [-0.0457;-0.0248; 0.0392] * ... % Via point of gluteus maximus I (considered as insertion)
    Segment(6).rScale; 
Segment(5).nV(:,8)  = inv(Segment(5).B) * ...
    [-0.0426;-0.0530; 0.0293] * ... % Via point of gluteus maximus II (considered as insertion)
    Segment(6).rScale; 
Segment(5).nV(:,9)  = inv(Segment(5).B) * ...
    [-0.0299;-0.1041; 0.0135] * ... % Via point of gluteus maximus III (considered as insertion)
    Segment(6).rScale; 
Segment(5).nV(:,10) = inv(Segment(5).B) * ...
    [-0.0218;-0.0117; 0.0555] * ... % Insertion of gluteus medius I
    Segment(6).rScale; 
Segment(5).nV(:,11) = inv(Segment(5).B) * ...
    [-0.0258;-0.0058; 0.0527] * ... % Insertion of gluteus medius II
    Segment(6).rScale; 
Segment(5).nV(:,12) = inv(Segment(5).B) * ...
    [-0.0309;-0.0047; 0.0518] * ... % Insertion of gluteus medius III
    Segment(6).rScale; 
Segment(5).nV(:,13) = inv(Segment(5).B) * ...
    [-0.0072;-0.0104; 0.0560] * ... % Insertion of gluteus minimus I
    Segment(6).rScale; 
Segment(5).nV(:,14) = inv(Segment(5).B) * ...
    [-0.0096;-0.0104; 0.0560] * ... % Insertion of gluteus minimus II
    Segment(6).rScale; 
Segment(5).nV(:,15) = inv(Segment(5).B) * ...
    [-0.0135;-0.0083; 0.0550] * ... % Insertion of gluteus minimus III
    Segment(6).rScale; 
Segment(5).nV(:,16) = inv(Segment(5).B) * ...
    [0.0050;-0.2111; 0.0234] * ... % Insertion of adductor longus
    Segment(6).rScale; 
Segment(5).nV(:,17) = inv(Segment(5).B) * ...
    [0.0009;-0.1196; 0.0294] * ... % Insertion of adductor brevis
    Segment(6).rScale; 
Segment(5).nV(:,18) = inv(Segment(5).B) * ...
    [-0.0045;-0.1211; 0.0339] * ... % Insertion of adductor magnus I
    Segment(6).rScale; 
Segment(5).nV(:,19) = inv(Segment(5).B) * ...
    [0.0054;-0.2285; 0.0227] * ... % Insertion of adductor magnus II
    Segment(6).rScale; 
Segment(5).nV(:,20) = inv(Segment(5).B) * ...
    [0.0070;-0.3837;-0.0266] *...  % Insertion of adductor magnus III
    Segment(6).rScale; 
Segment(5).nV(:,21) = inv(Segment(5).B) * ...
    [-0.0122;-0.0822; 0.0253] * ... % Insertion of pectineus
    Segment(6).rScale; 
Segment(5).nV(:,22) = inv(Segment(5).B) * ...
    [ 0.0017;-0.0543; 0.0057] * ... % Via point of illiacus (considered as insertion)
    Segment(6).rScale; 
Segment(5).nV(:,23) = inv(Segment(5).B) * ...
    [ 0.0016;-0.0507; 0.0038] * ... % Via point of psoas (considered as insertion)
    Segment(6).rScale; 
Segment(5).nV(:,24) = inv(Segment(5).B) * ...
    [-0.0381;-0.0359; 0.0366] * ... % Insertion of quadratus femoris
    Segment(6).rScale; 
Segment(5).nV(:,25) = inv(Segment(5).B) * ...
    [-0.0142;-0.0033; 0.0443] * ... % Insertion of gemellus
    Segment(6).rScale; 
Segment(5).nV(:,26) = inv(Segment(5).B) * ...
    [-0.0148;-0.0036; 0.0437] * ... % Insertion of piriformis
    Segment(6).rScale; 
Segment(5).nV(:,27) = inv(Segment(5).B) * ...
    [0.0294;-0.0995; 0.0597] * ... % Via point tensor fasciae latae (most proximal on thigh)
    Segment(6).rScale; 
Segment(5).nV(:,30) = inv(Segment(5).B) * ... 
    [0.0050;-0.2111; 0.0234] * ... % Origin of biceps femoris short head
    Segment(6).rScale; 
%
% Other muscle points scaled by thigh (i = 5) geometry
% Original insertions expressed in femur coordinate system (centre at rP5)
% SCS centre relocalised at mid-epicondyles (rD5)
% Scaled by an homothety of centre (rD5)
Segment(5).nV(:,28) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([0.0054;-0.4049; 0.0357] ... % Via point tensor fasciae latae (most distal on thigh)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,29) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([-0.0030;-0.3568;-0.0421] ... % Via point of sartorius
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,31) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([0.0334;-0.4030; 0.0019] ... % Via point of rectus femoris (from -83.65 to -150 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,32) = inv(Segment(5).B) * ...
    ([0.0356;-0.2769; 0.0009] ... % Via point of vastus medialis (considered as origin from 0 to -69.32 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,33) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([0.0370;-0.4048;-0.0125] ... % Via point of vastus medialis (considered as origin from -69.32 to -101.99 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,34) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([0.0274;-0.4255;-0.0131] ... % Via point of vastus medialis (considered as origin from -101.99 to -150 of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,35) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([0.0335;-0.2084; 0.0285] ... % Via point of vastus intermedialis (considered as origin from 0 to -81.36 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,36) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([0.0343;-0.4030; 0.0055] ...  % Via point of vastus intermedialis (considered as origin from -81.36 to -150 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,37) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([0.0269;-0.2591; 0.0409] ... % Via point of vastus lateralis (considered as origin from 0 to -69.32 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,38) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([0.0361;-0.4030; 0.0205] ... % Via point of vastus lateralis (considered as origin from -69.32 to -110 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,39) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([0.0253;-0.4243; 0.0184] ... % Via point of vastus lateralis (considered as origin from -110 to -150 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,40) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([-0.0239;-0.4022;-0.0258] ... % Via point (considered as origin) of gastrocnemius medialis (from 5.73 to -44.12 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,41) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([-0.0127;-0.3929;-0.0235] ... % Origin of gastrocnemius medialis (from -44.12 to -150 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,42) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([-0.0254;-0.4018; 0.0274] ... % Via point (considered as origin) of gastrocnemius lateralis (from 5.73 to -44.12 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;
Segment(5).nV(:,43) = [0; -1; 0] + inv(Segment(5).B) * ...
    ([-0.0155;-0.3946; 0.0272] ... % Origin of gastrocnemius lateralis (from -44.12 to -150 degrees of knee flexion)
    + [0; Model.geometry.Lm(5); 0]) * ...
    Segment(5).rScale;

% Pelvis (i = 6)
% Virtual markers start at 2 (other is for hip joint)
% Original insertions expressed in pelvis coordinate system (centre at mid-ASIS)
% SCS centre relocalised at mid hip joint centres (centre of right and left rD6)
% Scaled by an homothety of centre (rD6)
Segment(6).nV(:,2)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.1291; 0.0012; 0.0886] ... % Via point gluteus maximus I (considered as origin)
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,3)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.1376;-0.0520; 0.0914] ... % Via point gluteus maximus II (considered as origin)
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,4)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.1529;-0.1052; 0.0403]  ... % Via point gluteus maximus III (considered as origin)
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,5)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0408; 0.0304; 0.1209] ... % Origin of gluteus medius I
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,6)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0855; 0.0445; 0.0766] ... % Origin of gluteus medius II
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,7)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.1223; 0.0105; 0.0648] ... % Origin of gluteus medius III
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,8)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0467;-0.0080; 0.1056] ... % Origin of gluteus minimus I
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,9)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0633;-0.0065; 0.0991] ... % Origin of gluteus minimus II
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,10) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0834;-0.0063; 0.0856] ... % Origin of gluteus minimus III
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,11) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0316;-0.0836; 0.0169] ... % Origin of adductor longus
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,12) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0587;-0.0915; 0.0164] ... % Origin of adductor brevis
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,13) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0732;-0.1174; 0.0255] ... % Origin of adductor magnus I
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,14) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0831;-0.1192; 0.0308] ... % Origin of adductor magnus II
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,15) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0771;-0.1181; 0.0276] ... % Origin of adductor magnus III
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,16) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0431;-0.0768; 0.0451] ... % Origin of pectineus
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,17) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0218;-0.0550; 0.0851] ... % Via point of illiacus (considered as origin)
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,18) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0238;-0.0570; 0.0759] ... % Via point of psoas (considered as origin)
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,19) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.1143;-0.1151; 0.0520] ... % Origin of quadrutus femoris
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,20) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.1133;-0.0820; 0.0714] ... % Origin of gemellus
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,21) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.1193;-0.0276; 0.0657] ... % Via point piriformis
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,22) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0311; 0.0214; 0.1241] ... % Origin of tensor fasciae latae
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,23) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0563;-0.1038; 0.0079] ... % Origin of gracillis
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,24) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.1192;-0.1015; 0.0695] ... % Origin of semimembranosus
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,25) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.1237;-0.1043; 0.0603] ... % Origin of semitendinus
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,26) = Segment(6).nV(:,1) + inv(Segment(6).B) * ....
    ([-0.1244;-0.1001; 0.0666] ... % Origin of biceps femoris long head
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,27) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0153;-0.0013; 0.1242] ... % Origin of sartorius
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;
Segment(6).nV(:,28) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.0295;-0.0311; 0.0968] ... % Origin of rectus femoris
    + Model.geometry.T_pelvi_femur) * ...
    Segment(5).rScale;

% -------------------------------------------------------------------------
% Interpolation matrices
% -------------------------------------------------------------------------

for i = 2:6 % From i = 2 (Foot) to i = 6 (Pelvis)
    switch i
        case 2
            nj = 4:15; % Virtual markers start at 4 (others are for ankle joint)
        case 3
            nj = 10:28; % Virtual markers start at 10 (others are for ankle, tibio-femoral and patello-femoral joints)
        case 4
            nj = 2:5; % Virtual markers start at 2 (other is for patello-femoral joint)
        case 5
            nj = 7:43; % Virtual markers start at 7 (others are for tibio-femoral joint)
        case 6
            nj = 2:28; % Virtual markers start at 2 (other is for hip joint)
    end
    for j = nj
        % Interpolation matrix
        eval(['NV',num2str(j),num2str(i),...
            '= [Segment(',num2str(i),').nV(1,',num2str(j),')*eye(3),',...
            '(1 + Segment(',num2str(i),').nV(2,',num2str(j),'))*eye(3),',...
            '- Segment(',num2str(i),').nV(2,',num2str(j),')*eye(3),',...
            'Segment(',num2str(i),').nV(3,',num2str(j),')*eye(3)];']);
    end
end

% -------------------------------------------------------------------------
% Knee flexion angle
% -------------------------------------------------------------------------
Joint(3).T = Mprod_array3(Tinv_array3(Q2Twu_array3(Segment(5).Q)), ...
    Q2Tuv_array3(Segment(3).Q));
Joint(3).Euler = R2mobileZXY_array3(Joint(3).T(1:3,1:3,:));
FE3 = permute(Joint(3).Euler(1,1,:),[3,2,1])*180/pi;             


% -------------------------------------------------------------------------
% Generalised lever arms
% -------------------------------------------------------------------------

% Initialisation
Model.Lever = zeros(48,43,n);

% Gluteus maximus I
Model.Lever(:,1,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV75',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV26,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV75,[1,1,n]),Segment(5).Q)))];

% Gluteus maximus II
Model.Lever(:,2,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV85',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV36,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV85,[1,1,n]),Segment(5).Q)))];

% Gluteus maximus III
Model.Lever(:,3,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV95',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV46,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV95,[1,1,n]),Segment(5).Q)))];

% Gluteus medius I
Model.Lever(:,4,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV105',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV56,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV105,[1,1,n]),Segment(5).Q)))];

% Gluteus medius II
Model.Lever(:,5,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV115',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV66,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV115,[1,1,n]),Segment(5).Q)))];

% Gluteus medius III
Model.Lever(:,6,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV125',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV76,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV125,[1,1,n]),Segment(5).Q)))];

% Gluteus minimus I
Model.Lever(:,7,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV135',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV86,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV135,[1,1,n]),Segment(5).Q)))];

% Gluteus minimus II
Model.Lever(:,8,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV145',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV96,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV145,[1,1,n]),Segment(5).Q)))];

% Gluteus minimus III
Model.Lever(:,9,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV155',[1,1,n]),....
    Vnorm_array3(Mprod_array3(repmat(NV106,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV155,[1,1,n]),Segment(5).Q)))];

% Adductor longus
Model.Lever(:,10,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV165',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV116,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV165,[1,1,n]),Segment(5).Q)))];

% Adductor brevis
Model.Lever(:,11,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV175',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV126,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV175,[1,1,n]),Segment(5).Q)))];

% Adductor magnus I
Model.Lever(:,12,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV185',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV136,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV185,[1,1,n]),Segment(5).Q)))];

% Adductor magnus II
Model.Lever(:,13,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV195',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV146,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV195,[1,1,n]),Segment(5).Q)))];

% Adductor magnus III
Model.Lever(:,14,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV205',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV156,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV205,[1,1,n]),Segment(5).Q)))];

% Pectineus
Model.Lever(:,15,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV215',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV166,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV215,[1,1,n]),Segment(5).Q)))];

% Illiacus
Model.Lever(:,16,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV225',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV176,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV225,[1,1,n]),Segment(5).Q)))];

% Psoas
Model.Lever(:,17,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV235',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV186,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV235,[1,1,n]),Segment(5).Q)))];

% Quadratus femoris
Model.Lever(:,18,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV245',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV196,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV245,[1,1,n]),Segment(5).Q)))];

% Gemellus
Model.Lever(:,19,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV255',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV206,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV255,[1,1,n]),Segment(5).Q)))];

% Piriformis
Model.Lever(:,20,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV265',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV216,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV265,[1,1,n]),Segment(5).Q)))];

% Tensor fasciae latae
Model.Lever(:,21,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV103',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV285,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV103,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV275',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV226,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV275,[1,1,n]),Segment(5).Q))) ...
    - Mprod_array3(repmat(NV285',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV285,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV103,[1,1,n]),Segment(3).Q)))];

% Gracilis
Model.Lever(:,22,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV113',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV236,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV113,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Sartorius
Model.Lever(:,23,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV153',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV295,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV153,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV295',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV276,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV295,[1,1,n]),Segment(5).Q))) ...
    - Mprod_array3(repmat(NV295',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV295,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV153,[1,1,n]),Segment(3).Q)))];

% Semimenbranosus
Model.Lever(:,24,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV123',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV246,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV123,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Semitendinosus
Model.Lever(:,25,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV133',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV256,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV133,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Biceps femoris long head
Model.Lever(:,26,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV143',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV266,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV143,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Biceps femoris short head
Model.Lever(:,27,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV163',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV305,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV163,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    - Mprod_array3(repmat(NV305',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV305,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV163,[1,1,n]),Segment(3).Q)))];

% Rectus femoris
Model.Lever(:,28,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV24',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV286,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV24,[1,1,n]),Segment(4).Q)));...
    zeros(12,1,n)];
% % Moving point in case of tibio-femoral angle < - 83.65 degrees
% ind = find(FE3 < -83.65);
% if ~isempty(ind)
%     display(['Using via point V315 for rectus femoris at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,28,ind) = [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV24',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV315,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV24,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         Mprod_array3(repmat(NV315',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV286,[1,1,ni]),Segment(6).Q(:,:,ind)) - Mprod_array3(repmat(NV315,[1,1,ni]),Segment(5).Q(:,:,ind)))) ...
%         - Mprod_array3(repmat(NV315',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV315,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV24,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end

% Vastus medialis
% Using V325 as virtual marker for origin
Model.Lever(:,29,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV34',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV325,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV34,[1,1,n]),Segment(4).Q)));...
    - Mprod_array3(repmat(NV325',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV325,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV34,[1,1,n]),Segment(4).Q)))];
% % Using V335 as virtual marker for origin
% ind = find(FE3 < -69.32 & FE3 > -101.99);
% if ~isempty(ind)
%     display(['Using origin V335 for vastus medialis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,29,ind) =  [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV34',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV335,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV335',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV335,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end
% % Using V345 as virtual marker for origin
% ind = find(FE3 < -101.99);
% if ~isempty(ind)
%     display(['Using origin V345 for vastus medialis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,29,ind) = [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV34',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV345,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV345',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV345,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end

% Vastus intermedialis
% Using V355 as virtual marker for origin
Model.Lever(:,30,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV44',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV355,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV44,[1,1,n]),Segment(4).Q)));...
    - Mprod_array3(repmat(NV355',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV355,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV44,[1,1,n]),Segment(4).Q)))];
% % Using V365 as virtual marker for origin
% ind = find(FE3 < -81.36);
% if ~isempty(ind)
%     display(['Using origin V365 for vastus intermedialis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,30,ind) = [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV44',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV365,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV44,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV365',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV365,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV44,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end

% Vastus lateralis
% Using V375 as virtual marker for origin
Model.Lever(:,31,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV54',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV375,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV54,[1,1,n]),Segment(4).Q)));...
    - Mprod_array3(repmat(NV375',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV375,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV54,[1,1,n]),Segment(4).Q)))];
% % Using V385 as virtual marker for origin
% ind = find(FE3 < -69.32 & FE3 > -110);
% if ~isempty(ind)
%     display(['Using origin V385 for vastus lateralis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,31,ind) = [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV54',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV385,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV385',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV385,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end
% % Using V395 as virtual marker for origin
% ind = find(FE3 < -110);
% if ~isempty(ind)
%     display(['Using origin V395 for vastus lateralis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,31,ind) = [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV54',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV395',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end

% Gastrocnemius medialis
% Using V405 as virtual marker for via point in the thigh
Model.Lever(:,32,1:n) = [Mprod_array3(repmat(NV42',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV173,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV42,[1,1,n]),Segment(2).Q)));...
    Mprod_array3(repmat(NV173',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV405,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV173,[1,1,n]),Segment(3).Q)) ...
    - Vnorm_array3(Mprod_array3(repmat(NV173,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV42,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    - Mprod_array3(repmat(NV405',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV405,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV173,[1,1,n]),Segment(3).Q)))];
% % Using V415 as virtual marker for via point in the thigh
% ind = find(FE3 < -44.12);
% if ~isempty(ind)
%     display(['Using origin V415 for gastrocnemius medialis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,32,ind) = [Mprod_array3(repmat(NV42',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV173,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV42,[1,1,ni]),Segment(2).Q(:,:,ind))));...
%         Mprod_array3(repmat(NV173',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV415,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV173,[1,1,ni]),Segment(3).Q(:,:,ind)))...
%         - Vnorm_array3(Mprod_array3(repmat(NV173,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV42,[1,1,ni]),Segment(2).Q(:,:,ind))));...
%         zeros(12,1,ni);...
%         - Mprod_array3(repmat(NV415',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV415,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV173,[1,1,ni]),Segment(3).Q(:,:,ind))))];
% end

% Gastrocnemius lateralis       
% Using V425 as virtual marker for via point in the thigh
Model.Lever(:,33,1:n) = [Mprod_array3(repmat(NV52',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV52,[1,1,n]),Segment(2).Q)));...
    Mprod_array3(repmat(NV183',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV425,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q)) ...
    - Vnorm_array3(Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV52,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    - Mprod_array3(repmat(NV425',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV425,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q)))];
% % Using V435 as virtual marker for via point in the thigh
% ind = find(FE3 < -44.12);
% if ~isempty(ind)
%     display(['Using origin V435 for gastrocnemius lateralis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,33,ind) = [Mprod_array3(repmat(NV52',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV183,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV52,[1,1,ni]),Segment(2).Q(:,:,ind))));...
%         Mprod_array3(repmat(NV183',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV435,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV183,[1,1,ni]),Segment(3).Q(:,:,ind))) ...
%         - Vnorm_array3(Mprod_array3(repmat(NV183,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV52,[1,1,ni]),Segment(2).Q(:,:,ind))));...
%         zeros(12,1,ni);...
%         - Mprod_array3(repmat(NV435',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV435,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV183,[1,1,ni]),Segment(3).Q(:,:,ind))))];
% end

% Soleus
Model.Lever(:,34,1:n) = [Mprod_array3(repmat(NV62',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV193,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV62,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV193',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV193,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV62,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Tibialis posterior
Model.Lever(:,35,1:n) = [Mprod_array3(repmat(NV72',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV203,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV72,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV203',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV203,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV72,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Tibialis anterior
Model.Lever(:,36,1:n) = [Mprod_array3(repmat(NV82',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV213,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV82,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV213',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV213,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV82,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Peroneus brevis
Model.Lever(:,37,1:n) = [Mprod_array3(repmat(NV92',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV223,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV92,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV223',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV223,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV92,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Peroneus longus
Model.Lever(:,38,1:n) = [Mprod_array3(repmat(NV102',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV233,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV102,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV233',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV233,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV102,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Peroneus tertius
Model.Lever(:,39,1:n) = [Mprod_array3(repmat(NV112',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV243,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV112,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV243',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV243,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV112,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Extensor digitorum longus
Model.Lever(:,40,1:n) = [Mprod_array3(repmat(NV122',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV253,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV122,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV253',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV253,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV122,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Extensor hallucis longus
Model.Lever(:,41,1:n) = [Mprod_array3(repmat(NV132',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV263,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV132,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV263',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV263,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV132,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Flexor digitorum longus
Model.Lever(:,42,1:n) = [Mprod_array3(repmat(NV142',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV273,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV142,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV273',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV273,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV142,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Flexor hallucis longus
Model.Lever(:,43,1:n) = [Mprod_array3(repmat(NV152',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV283,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV152,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV283',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV283,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV152,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];


% -------------------------------------------------------------------------
% Force max (Delp 1990 = Wickiewicz 1983 & Brand 1986)
% -------------------------------------------------------------------------
Model.Fmax(1,1) = 382;           % Gluteus maximus I
Model.Fmax(2,1) = 546;           % Gluteus maximus II
Model.Fmax(3,1) = 368;           % Gluteus maximus III
Model.Fmax(4,1) = 546;           % Gluteus medius I
Model.Fmax(5,1) = 383;           % Gluteus medius II
Model.Fmax(6,1) = 435;           % Gluteus medius III
Model.Fmax(7,1) = 180;           % Gluteus minimus I
Model.Fmax(8,1) = 190;           % Gluteus minimus II
Model.Fmax(9,1) = 215;           % Gluteus minimus III
Model.Fmax(10,1) = 418;          % Adductor longus
Model.Fmax(11,1) = 286;          % Adductor brevis
Model.Fmax(12,1) = 346;          % Adductor magnus I
Model.Fmax(13,1) = 312;          % Adductor magnus II
Model.Fmax(14,1) = 444;          % Adductor magnus III
Model.Fmax(15,1) = 177;          % Pectineus
Model.Fmax(16,1) = 429;          % Illiacus
Model.Fmax(17,1) = 371;          % Psoas
Model.Fmax(18,1) = 254;          % Quadratus femoris
Model.Fmax(19,1) = 109;          % Gemelli
Model.Fmax(20,1) = 296;          % Piriformis
Model.Fmax(21,1) = 155;          % Tensor fasciae latae
Model.Fmax(22,1) = 108;          % Gracilis 
Model.Fmax(23,1) = 104;          % Sartorius
Model.Fmax(24,1) = 1030;         % Semimembranosus
Model.Fmax(25,1) = 328;          % Semitendinosus
Model.Fmax(26,1) = 717;          % Biceps femoris long head
Model.Fmax(27,1) = 402;          % Biceps femoris short head
Model.Fmax(28,1) = 779;          % Rectus femoris
Model.Fmax(29,1) = 1294;         % Vastus medialis
Model.Fmax(30,1) = 1365;         % Vastus intermedius
Model.Fmax(31,1) = 1871;         % Vastus lateralis
Model.Fmax(32,1) = 1113;         % Gastrocnemius medialis
Model.Fmax(33,1) = 488;          % Gastrocnemius lateralis
Model.Fmax(34,1) = 2839;         % Soleus
Model.Fmax(35,1) = 1270;         % Tibialis posterior
Model.Fmax(36,1) = 603;          % Tibialis anterior
Model.Fmax(37,1) = 348;          % Peroneus brevis
Model.Fmax(38,1) = 754;          % Peroneus longus
Model.Fmax(39,1) = 90;           % Peroneus tertius
Model.Fmax(40,1) = 341;          % Extensor digitorum longus
Model.Fmax(41,1) = 108;          % Extensor hallucis longus
Model.Fmax(42,1) = 310;          % Flexor digitorum longus
Model.Fmax(43,1) = 322;          % Flexor hallucis longus

% -------------------------------------------------------------------------
% PCSA (Thorpe 1997 + Friedrich and Brand 1990)
% -------------------------------------------------------------------------
Model.PCSA(1,1) = 41.7/3;        % Gluteus maximus I
Model.PCSA(2,1) = 41.7/3;        % Gluteus maximus II
Model.PCSA(3,1) = 41.7/3;        % Gluteus maximus III
Model.PCSA(4,1) = 21.60;         % Gluteus medius I
Model.PCSA(5,1) = 15.70;         % Gluteus medius II
Model.PCSA(6,1) = 16.80;         % Gluteus medius III
Model.PCSA(7,1) = 9.60;          % Gluteus minimus I
Model.PCSA(8,1) = 10.00;         % Gluteus minimus II
Model.PCSA(9,1) = 11.00;         % Gluteus minimus III
Model.PCSA(10,1) = 15.00;        % Adductor longus
Model.PCSA(11,1) = 9.70;         % Adductor brevis
Model.PCSA(12,1) = (22+25)/3;    % Adductor magnus I
Model.PCSA(13,1) = (22+25)/3;    % Adductor magnus II
Model.PCSA(14,1) = (22+25)/3;    % Adductor magnus III
Model.PCSA(15,1) = 5.40;         % Pectineus
Model.PCSA(16,1) = 32.00;        % Illiacus
Model.PCSA(17,1) = 15.6;         % Psoas
Model.PCSA(18,1) = 21.00;        % Quadratus femoris
Model.PCSA(19,1) = 4.33;         % Gemelli
Model.PCSA(20,1) = 20.54;        % Piriformis
Model.PCSA(21,1) = 5.20;         % Tensor fasciae latae
Model.PCSA(22,1) = 3.40;         % Gracilis 
Model.PCSA(23,1) = 3.65;         % Sartorius
Model.PCSA(24,1) = 39.90;        % Semimembranosus
Model.PCSA(25,1) = 9.40;         % Semitendinosus
Model.PCSA(26,1) = 28.80;        % Biceps femoris long head
Model.PCSA(27,1) = 8.14;         % Biceps femoris short head
Model.PCSA(28,1) = 33.60;        % Rectus femoris
Model.PCSA(29,1) = 46.70;        % Vastus medialis
Model.PCSA(30,1) = 53.70;        % Vastus intermedius
Model.PCSA(31,1) = 68.80;        % Vastus lateralis
Model.PCSA(32,1) = 41.80;        % Gastrocnemius medialis
Model.PCSA(33,1) = 19.90;        % Gastrocnemius lateralis
Model.PCSA(34,1) = 118.70;       % Soleus
Model.PCSA(35,1) = 36.20;        % Tibialis posterior
Model.PCSA(36,1) = 20.40;        % Tibialis anterior
Model.PCSA(37,1) = 11.50;        % Peroneus brevis
Model.PCSA(38,1) = 21.40;        % Peroneus longus
Model.PCSA(39,1) = 4.14;         % Peroneus tertius
Model.PCSA(40,1) = 10.50;        % Extensor digitorum longus
Model.PCSA(41,1) = 4.85;         % Extensor hallucis longus
Model.PCSA(42,1) = 9.90;         % Flexor digitorum longus
Model.PCSA(43,1) = 14.10;        % Flexor hallucis longus

% -------------------------------------------------------------------------
% Optimal isometric length (m) (Delp 1990)
% -------------------------------------------------------------------------
Model.L0(1,1) = 0.14200000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus maximus I
Model.L0(2,1) = 0.14700000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus maximus II
Model.L0(3,1) = 0.14400000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus maximus III
Model.L0(4,1) = 0.05350000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus medius I
Model.L0(5,1) = 0.08450000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus medius II
Model.L0(6,1) = 0.06460000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus medius III
Model.L0(7,1) = 0.06800000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus minimus I
Model.L0(8,1) = 0.05600000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus minimus II
Model.L0(9,1) = 0.03800000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus minimus III
Model.L0(10,1) = 0.13800000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor longus
Model.L0(11,1) = 0.13300000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor brevis
Model.L0(12,1) = 0.08700000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor magnus I
Model.L0(13,1) = 0.12100000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor magnus II
Model.L0(14,1) = 0.13100000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor magnus III
Model.L0(15,1) = 0.13300000 * Segment(5).L/Model.geometry.Lm(5);    % Pectineus
Model.L0(16,1) = 0.10000000 * Segment(5).L/Model.geometry.Lm(5);    % Iliacus
Model.L0(17,1) = 0.10400000 * Segment(5).L/Model.geometry.Lm(5);    % Psoas
Model.L0(18,1) = 0.05400000 * Segment(5).L/Model.geometry.Lm(5);    % Quadratus femoris
Model.L0(19,1) = 0.02400000 * Segment(5).L/Model.geometry.Lm(5);    % Gemelli
Model.L0(20,1) = 0.02600000 * Segment(5).L/Model.geometry.Lm(5);    % Piriformis
Model.L0(21,1) = 0.09500000 * Segment(5).L/Model.geometry.Lm(5);    % Tensor fascia latae
Model.L0(22,1) = 0.35200000 * Segment(5).L/Model.geometry.Lm(5);    % Gracilis 
Model.L0(23,1) = 0.57900000 * Segment(5).L/Model.geometry.Lm(5);    % Sartorius
Model.L0(24,1) = 0.08000000 * Segment(5).L/Model.geometry.Lm(5);    % Semimembranosus
Model.L0(25,1) = 0.20100000 * Segment(5).L/Model.geometry.Lm(5);    % Semitendinosus
Model.L0(26,1) = 0.10900000 * Segment(5).L/Model.geometry.Lm(5);    % Biceps femoris long head
Model.L0(27,1) = 0.17300000 * Segment(5).L/Model.geometry.Lm(5);    % Biceps femoris short head
Model.L0(28,1) = 0.08400000 * Segment(5).L/Model.geometry.Lm(5);    % Rectus femoris
Model.L0(29,1) = 0.08900000 * Segment(5).L/Model.geometry.Lm(5);    % Vastus medialis
Model.L0(30,1) = 0.08700000 * Segment(5).L/Model.geometry.Lm(5);    % Vastus intermedialis
Model.L0(31,1) = 0.08400000 * Segment(5).L/Model.geometry.Lm(5);    % Vastus lateralis
Model.L0(32,1) = 0.04500000 * Segment(3).L/Model.geometry.Lm(3);    % Gastrocnemius medialis
Model.L0(33,1) = 0.06400000 * Segment(3).L/Model.geometry.Lm(3);    % Gastrocnemius lateralis
Model.L0(34,1) = 0.03000000 * Segment(3).L/Model.geometry.Lm(3);    % Soleus
Model.L0(35,1) = 0.03100000 * Segment(3).L/Model.geometry.Lm(3);    % Tibialis posterior
Model.L0(36,1) = 0.09800000 * Segment(3).L/Model.geometry.Lm(3);    % Tibialis anterior
Model.L0(37,1) = 0.05000000 * Segment(3).L/Model.geometry.Lm(3);    % Peroneus brevis
Model.L0(38,1) = 0.04900000 * Segment(3).L/Model.geometry.Lm(3);    % Peroneus longus
Model.L0(39,1) = 0.07900000 * Segment(3).L/Model.geometry.Lm(3);    % Peroneus tertius
Model.L0(40,1) = 0.10200000 * Segment(3).L/Model.geometry.Lm(3);    % Extensor digitorum longus
Model.L0(41,1) = 0.11100000 * Segment(3).L/Model.geometry.Lm(3);    % Extensor hallucis longus
Model.L0(42,1) = 0.03400000 * Segment(3).L/Model.geometry.Lm(3);    % Flexor digitorum longus
Model.L0(43,1) = 0.04300000 * Segment(3).L/Model.geometry.Lm(3);    % Flexor hallucis longus

% -------------------------------------------------------------------------
% Maximum contraction velocity of the fibers, in optimal fiberlengths
% per second (m/sec) (Delp 1990)
% -------------------------------------------------------------------------
for i = 1:43
    Model.V0max(i,1) = 10 * Model.L0(i,1);
end

% -------------------------------------------------------------------------
% Tendon slack length (m) (Delp 1990)
% -------------------------------------------------------------------------
Model.Lts(1,1) = 0.12500000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus maximus I
Model.Lts(2,1) = 0.12700000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus maximus II
Model.Lts(3,1) = 0.14500000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus maximus III
Model.Lts(4,1) = 0.07800000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus medius I
Model.Lts(5,1) = 0.05300000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus medius II
Model.Lts(6,1) = 0.05300000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus medius III
Model.Lts(7,1) = 0.01600000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus minimus I
Model.Lts(8,1) = 0.02600000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus minimus II
Model.Lts(9,1) = 0.05100000 * Segment(5).L/Model.geometry.Lm(5);     % Gluteus minimus III
Model.Lts(10,1) = 0.11000000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor longus
Model.Lts(11,1) = 0.02000000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor brevis
Model.Lts(12,1) = 0.06000000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor magnus I
Model.Lts(13,1) = 0.13000000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor magnus II
Model.Lts(14,1) = 0.26000000 * Segment(5).L/Model.geometry.Lm(5);    % Adductor magnus III
Model.Lts(15,1) = 0.00100000 * Segment(5).L/Model.geometry.Lm(5);    % Pectineus
Model.Lts(16,1) = 0.09000000 * Segment(5).L/Model.geometry.Lm(5);    % Iliacus
Model.Lts(17,1) = 0.13000000 * Segment(5).L/Model.geometry.Lm(5);    % Psoas
Model.Lts(18,1) = 0.02400000 * Segment(5).L/Model.geometry.Lm(5);    % Quadratus femoris
Model.Lts(19,1) = 0.03900000 * Segment(5).L/Model.geometry.Lm(5);    % Gemelli
Model.Lts(20,1) = 0.11500000 * Segment(5).L/Model.geometry.Lm(5);    % Piriformis
Model.Lts(21,1) = 0.42500000 * Segment(5).L/Model.geometry.Lm(5);    % Tensor fascia latae
Model.Lts(22,1) = 0.14000000 * Segment(5).L/Model.geometry.Lm(5);    % Gracilis 
Model.Lts(23,1) = 0.04000000 * Segment(5).L/Model.geometry.Lm(5);    % Sartorius
Model.Lts(24,1) = 0.35900000 * Segment(5).L/Model.geometry.Lm(5);    % Semimembranosus
Model.Lts(25,1) = 0.26200000 * Segment(5).L/Model.geometry.Lm(5);    % Semitendinosus
Model.Lts(26,1) = 0.34100000 * Segment(5).L/Model.geometry.Lm(5);    % Biceps femoris long head
Model.Lts(27,1) = 0.10000000 * Segment(5).L/Model.geometry.Lm(5);    % Biceps femoris short head
Model.Lts(28,1) = 0.34600000 * Segment(5).L/Model.geometry.Lm(5);    % Rectus femoris
Model.Lts(29,1) = 0.12600000 * Segment(5).L/Model.geometry.Lm(5);    % Vastus medialis
Model.Lts(30,1) = 0.13600000 * Segment(5).L/Model.geometry.Lm(5);    % Vastus intermedialis
Model.Lts(31,1) = 0.15700000 * Segment(5).L/Model.geometry.Lm(5);    % Vastus lateralis
Model.Lts(32,1) = 0.40800000 * Segment(3).L/Model.geometry.Lm(3);    % Gastrocnemius medialis
Model.Lts(33,1) = 0.38500000 * Segment(3).L/Model.geometry.Lm(3);    % Gastrocnemius lateralis
Model.Lts(34,1) = 0.26800000 * Segment(3).L/Model.geometry.Lm(3);    % Soleus
Model.Lts(35,1) = 0.31000000 * Segment(3).L/Model.geometry.Lm(3);    % Tibialis posterior
Model.Lts(36,1) = 0.22300000 * Segment(3).L/Model.geometry.Lm(3);    % Tibialis anterior
Model.Lts(37,1) = 0.16100000 * Segment(3).L/Model.geometry.Lm(3);    % Peroneus brevis
Model.Lts(38,1) = 0.34500000 * Segment(3).L/Model.geometry.Lm(3);    % Peroneus longus
Model.Lts(39,1) = 0.10000000 * Segment(3).L/Model.geometry.Lm(3);    % Peroneus tertius
Model.Lts(40,1) = 0.34500000 * Segment(3).L/Model.geometry.Lm(3);    % Extensor digitorum longus
Model.Lts(41,1) = 0.30500000 * Segment(3).L/Model.geometry.Lm(3);    % Extensor hallucis longus
Model.Lts(42,1) = 0.40000000 * Segment(3).L/Model.geometry.Lm(3);    % Flexor digitorum longus
Model.Lts(43,1) = 0.38000000 * Segment(3).L/Model.geometry.Lm(3);    % Flexor hallucis longus

% -------------------------------------------------------------------------
% Pennation angle at optimal isometric length (radian) (Delp 1990)
% -------------------------------------------------------------------------
Model.pennation(1,1) = 0.08726646;           % Gluteus maximus I
Model.pennation(2,1) = 0.00000000;           % Gluteus maximus II
Model.pennation(3,1) = 0.08726646;           % Gluteus maximus III
Model.pennation(4,1) = 0.13962634;           % Gluteus medius I
Model.pennation(5,1) = 0.00000000;           % Gluteus medius II
Model.pennation(6,1) = 0.33161256;           % Gluteus medius III
Model.pennation(7,1) = 0.17453293;           % Gluteus minimus I
Model.pennation(8,1) = 0.00000000;           % Gluteus minimus II
Model.pennation(9,1) = 0.36651914;           % Gluteus minimus III
Model.pennation(10,1) = 0.10471976;          % Adductor longus
Model.pennation(11,1) = 0.00000000;          % Adductor brevis
Model.pennation(12,1) = 0.08726646;          % Adductor magnus I
Model.pennation(13,1) = 0.05235988;          % Adductor magnus II
Model.pennation(14,1) = 0.08726646;          % Adductor magnus III
Model.pennation(15,1) = 0.00000000;          % Pectineus
Model.pennation(16,1) = 0.12217305;          % Iliacus
Model.pennation(17,1) = 0.13962634;          % Psoas
Model.pennation(18,1) = 0.00000000;          % Quadratus femoris
Model.pennation(19,1) = 0.00000000;          % Gemelli
Model.pennation(20,1) = 0.17453293;          % Piriformis
Model.pennation(21,1) = 0.05235988;          % Tensor fascia latae
Model.pennation(22,1) = 0.05235988;          % Gracilis 
Model.pennation(23,1) = 0.00000000;          % Sartorius
Model.pennation(24,1) = 0.26179939;          % Semimembranosus
Model.pennation(25,1) = 0.08726646;          % Semitendinosus
Model.pennation(26,1) = 0.00000000;          % Biceps femoris long head
Model.pennation(27,1) = 0.40142573;          % Biceps femoris short head
Model.pennation(28,1) = 0.08726646;          % Rectus femoris
Model.pennation(29,1) = 0.08726646;          % Vastus medialis
Model.pennation(30,1) = 0.05235988;          % Vastus intermedialis
Model.pennation(31,1) = 0.08726646;          % Vastus lateralis
Model.pennation(32,1) = 0.29670597;          % Gastrocnemius medialis
Model.pennation(33,1) = 0.13962634;          % Gastrocnemius lateralis
Model.pennation(34,1) = 0.43633231;          % Soleus
Model.pennation(35,1) = 0.20943951;          % Tibialis posterior
Model.pennation(36,1) = 0.08726646;          % Tibialis anterior
Model.pennation(37,1) = 0.08726646;          % Peroneus brevis
Model.pennation(38,1) = 0.17453293;          % Peroneus longus
Model.pennation(39,1) = 0.22689280;          % Peroneus tertius
Model.pennation(40,1) = 0.13962634;          % Extensor digitorum longus
Model.pennation(41,1) = 0.10471976;          % Extensor hallucis longus
Model.pennation(42,1) = 0.12217305;          % Flexor digitorum longus
Model.pennation(43,1) = 0.17453293;          % Flexor hallucis longus

% -------------------------------------------------------------------------
% Musculo-tendon unit length
% -------------------------------------------------------------------------
% Initialisation
Model.Lmt = zeros(43,1,n);

% Gluteus maximus I
Model.Lmt(1,1,1:n) = ...
    repmat(norm([-0.1195; 0.0612; 0.0700] - ... % Origin of gluteus maximus I
    [-0.1291; 0.0012; 0.0886]) * ... % Via point 1 of gluteus maximus I
    Segment(5).rScale,[1,1,n]) + ... % In pelvis
    sqrt(sum((Mprod_array3(repmat(NV26,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV75,[1,1,n]),Segment(5).Q)).^2)) + ...
    repmat(norm([-0.0457;-0.0248; 0.0392] - ... % Via point 2 of gluteus maximus I
    [-0.0277; -0.0566; 0.0470]) * ... % Insertion of gluteus maximus I
    Segment(5).rScale,[1,1,n]); % In thigh

% Gluteus maximus II
Model.Lmt(2,1,1:n) = ...
    repmat(norm([-0.1349; 0.0176; 0.0563] - ... % Origin of gluteus maximus II
    [-0.1376;-0.0520; 0.0914]) * ... % Via point 1 of gluteus maximus II
    Segment(5).rScale,[1,1,n]) + ... % In pelvis
    sqrt(sum((Mprod_array3(repmat(NV36,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV85,[1,1,n]),Segment(5).Q)).^2)) + ...
    repmat(norm([-0.0426;-0.0530; 0.0293] - ... % Via point 2 of gluteus maximus II
    [-0.0156; -0.1016; 0.0419]) * ... % Insertion of gluteus maximus II
    Segment(5).rScale,[1,1,n]); % In thigh

% Gluteus maximus III
Model.Lmt(3,1,1:n) = ...
    repmat(norm([-0.1556; -0.0314; 0.0058] - ... % Origin of gluteus maximus III
    [-0.1529;-0.1052; 0.0403])*  ... % Via point 1 of gluteus maximus III
    Segment(5).rScale,[1,1,n]) + ... % In pelvis
    sqrt(sum((Mprod_array3(repmat(NV46,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV95,[1,1,n]),Segment(5).Q)).^2)) + ...
    repmat(norm([-0.0299;-0.1041; 0.0135] - ... % Via point 2 of gluteus maximus III
    [-0.0060; -0.1419; 0.0411]) * ... % Insertion of gluteus maximus III
    Segment(5).rScale,[1,1,n]); % In thigh

% Gluteus medius I
Model.Lmt(4,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV56,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV105,[1,1,n]),Segment(5).Q)).^2));

% Gluteus medius II
Model.Lmt(5,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV66,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV115,[1,1,n]),Segment(5).Q)).^2));

% Gluteus medius III
Model.Lmt(6,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV76,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV125,[1,1,n]),Segment(5).Q)).^2));

% Gluteus minimus I
Model.Lmt(7,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV86,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV135,[1,1,n]),Segment(5).Q)).^2));

% Gluteus minimus II
Model.Lmt(8,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV96,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV145,[1,1,n]),Segment(5).Q)).^2));

% Gluteus minimus III
Model.Lmt(9,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV106,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV155,[1,1,n]),Segment(5).Q)).^2));

% Adductus longus
Model.Lmt(10,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV116,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV165,[1,1,n]),Segment(5).Q)).^2));

% Adductus brevis
Model.Lmt(11,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV126,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV175,[1,1,n]),Segment(5).Q)).^2));

% Adductus magnus I
Model.Lmt(12,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV136,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV185,[1,1,n]),Segment(5).Q)).^2));

% Adductus magnus II
Model.Lmt(13,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV146,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV195,[1,1,n]),Segment(5).Q)).^2));

% Adductus magnus III
Model.Lmt(14,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV156,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV205,[1,1,n]),Segment(5).Q)).^2));

% Pectineus
Model.Lmt(15,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV166,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV215,[1,1,n]),Segment(5).Q)).^2));

% Iliacus
Model.Lmt(16,1,1:n) = ...
    repmat(norm([-0.0674; 0.0365; 0.0854] - ... % Origin of illiacus
    [-0.0218;-0.0550; 0.0851]) * ... % Via point 1 of illiacus
    Segment(5).rScale,[1,1,n]) + ... % In pelvis
    sqrt(sum((Mprod_array3(repmat(NV176,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV225,[1,1,n]),Segment(5).Q)).^2)) + ...
    repmat(norm([0.0017;-0.0543; 0.0057] - ... % Via point 2 of illiacus
    [-0.0193; -0.0621; 0.0129]) * ... % Insertion of illiacus
    Segment(5).rScale,[1,1,n]); % In thigh

% Psoas
Model.Lmt(17,1,1:n) = ...
    repmat(norm([-0.0647; 0.0887; 0.0289] - ... % Origin of psoas
    [-0.0238;-0.0570; 0.0759]) * ... % Via point 1 of psoas
    Segment(5).rScale, [1,1,n]) + ... % In pelvis
    sqrt(sum((Mprod_array3(repmat(NV186,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV235,[1,1,n]),Segment(5).Q)).^2)) + ...
    repmat(norm([0.0016;-0.0507; 0.0038] - ... % Via point 2 of psoas
    [-0.0188; -0.0597; 0.0104]) * ... % Insertion of psoas
    Segment(5).rScale,[1,1,n]); % In thigh

% Quadratus femoris
Model.Lmt(18,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV196,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV245,[1,1,n]),Segment(5).Q)).^2));

% Gemelli
Model.Lmt(19,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV206,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV255,[1,1,n]),Segment(5).Q)).^2));

% Piriformis
Model.Lmt(20,1,1:n) = ...
    repmat(norm([-0.1396; 0.0003; 0.0235] - ... % Origin of piriformis
    [-0.1193;-0.0276; 0.0657]) * ... % Via point 1 of piriformis
    Segment(5).rScale,[1,1,n]) + ... % In pelvis
    sqrt(sum((Mprod_array3(repmat(NV216,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV265,[1,1,n]),Segment(5).Q)).^2));

% Tensor fascia latae
Model.Lmt(21,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV226,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV275,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV275,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV285,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV285,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV103,[1,1,n]),Segment(3).Q)).^2));

% Gracilis
Model.Lmt(22,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV236,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV113,[1,1,n]),Segment(3).Q)).^2)) + ...
    repmat(norm([-0.0154;-0.0475;-0.0358] - ... % Via point 1 of gracilis
    [0.006; -0.0836; -0.0228]) * ... % Insertion of gracilis
    Segment(3).rScale,[1,1,n]); % In shank

% Sartorius
Model.Lmt(23,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV276,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV295,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV295,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV153,[1,1,n]),Segment(3).Q)).^2)) + ...
    repmat(norm([-0.0056;-0.0419;-0.0399] - ... % Via point 2 of sartorius
    [0.006; -0.0589; -0.0383]) * ... % Via point 3 of sartorius
    Segment(3).rScale + ... % In shank
    norm([0.006; -0.0589; -0.0383] - ... % Via point 3 of sartorius
    [0.0243; -0.0840; -0.0252]) * ... % Insertion of sartorius
    Segment(3).rScale,[1,1,n]); % In shank

% Semimembranosus
Model.Lmt(24,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV246,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV123,[1,1,n]),Segment(3).Q)).^2));

% Semitendinosus
Model.Lmt(25,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV256,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV133,[1,1,n]),Segment(3).Q)).^2)) + ...
    repmat(norm([-0.0314;-0.0545;-0.0146] - ... % Via point 1 of semitendinosus
    [-0.0113; -0.0746; -0.0245]) * ... % Via point 2 of semitendinosus
    Segment(3).rScale + ... % In shank
    norm([-0.0113; -0.0746; -0.0245] - ... % Via point 2 of semitendinosus
    [0.0027; -0.0956; -0.0193]) * ... % Insertion of semitendinosus
    Segment(3).rScale,[1,1,n]); % In shank

% Biceps femoris long head
Model.Lmt(26,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV266,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV143,[1,1,n]),Segment(3).Q)).^2));

% Biceps femoris short head
Model.Lmt(27,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV305,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV163,[1,1,n]),Segment(3).Q)).^2));

% Rectus femoris
Model.Lmt(28,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV286,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV24,[1,1,n]),Segment(4).Q)).^2));
% ind = find(FE3 < -83.65);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(28,1,ind) = ...
%         sqrt(sum((Mprod_array3(repmat(NV286,[1,1,ni]),Segment(6).Q(:,:,ind)) - Mprod_array3(repmat(NV315,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV315,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV24,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end

% Vastus medialis
Model.Lmt(29,1,1:n) = ...
    repmat(norm([0.0140; -0.2099; 0.0188] - ... % Origin of vastus medialis
    [0.0356;-0.2769; 0.0009]) * ... % Via point 1 of vastus medialis (from 0 to -69.32 degrees of knee flexion)
    Segment(5).rScale,[1,1,n]) + ... % In thigh
    sqrt(sum((Mprod_array3(repmat(NV325,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV34,[1,1,n]),Segment(4).Q)).^2));
% ind = find(FE3 <= -69.36 & FE3 > -101.99);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(29,1,ind) = ...
%     repmat(norm([0.0140; -0.2099; 0.0188] - ... % Origin of vastus medialis
%     [0.0356;-0.2769; 0.0009]) * ... % Via point 1 of vastus medialis (from 0 to -69.32 degrees of knee flexion)
%     Segment(5).rScale,[1,1,ni]) + ... % In thigh
%         sqrt(sum((Mprod_array3(repmat(NV325,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV335,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV335,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end
% ind = find(FE3 <= -101.99);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(29,1,ind) = ...
%         repmat(norm([0.0140; -0.2099; 0.0188] - ... % Origin of vastus medialis
%         [0.0356;-0.2769; 0.0009]) * ... % Via point 1 of vastus medialis (from 0 to -69.32 degrees of knee flexion)
%         Segment(5).rScale,[1,1,ni]) + ... % In thigh
%         sqrt(sum((Mprod_array3(repmat(NV325,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV335,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV335,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV345,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV345,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end

% Vastus intermedialis
Model.Lmt(30,1,1:n) = ...
    repmat(norm([0.0290; -0.1924; 0.0310] - ... % Origin of vastus intermedialis
    [0.0335;-0.2084; 0.0285]) * ... % Via point 1 of vastus intermedialis (from 0 to -81.36 degrees of knee flexion)
    Segment(5).rScale,[1,1,n]) + ... % In thigh
    sqrt(sum((Mprod_array3(repmat(NV355,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV44,[1,1,n]),Segment(4).Q)).^2));
% ind = find(FE3 <= -81.36);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(30,1,ind) = ...
%         repmat(norm([0.0290; -0.1924; 0.0310] - ... % Origin of vastus intermedialis
%         [0.0335;-0.2084; 0.0285]) * ... % Via point 1 of vastus intermedialis (from 0 to -81.36 degrees of knee flexion)
%         Segment(5).rScale,[1,1,ni]) + ... % In thigh
%         sqrt(sum((Mprod_array3(repmat(NV355,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV365,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV365,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV44,[1,1,n]),Segment(4).Q(:,:,ind))).^2));
% end

% Vastus lateralis
Model.Lmt(31,1,1:n) = ...
    repmat(norm([0.0048; -0.1854; 0.0349] - ... % Origin of vastus lateralis
    [0.0269;-0.2591; 0.0409]) * ... % Via point 1 of vastus lateralis (from 0 to -69.32 degrees of knee flexion)
    Segment(5).rScale,[1,1,n]) + ... % In thigh
    sqrt(sum((Mprod_array3(repmat(NV375,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV54,[1,1,n]),Segment(4).Q)).^2));
% ind = find(FE3 <= -69.36 & FE3 > -110.06);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(31,1,ind) = ...
%         repmat(norm([0.0048; -0.1854; 0.0349] - ... % Origin of vastus lateralis
%         [0.0269;-0.2591; 0.0409]) * ... % Via point 1 of vastus lateralis (from 0 to -69.32 degrees of knee flexion)
%         Segment(5).rScale,[1,1,ni]) + ... % In thigh
%         sqrt(sum((Mprod_array3(repmat(NV375,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV385,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV385,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end
% ind = find(FE3 <= -110.06);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(31,1,ind) = ...
%         repmat(norm([0.0048; -0.1854; 0.0349] - ... % Origin of vastus lateralis
%         [0.0269;-0.2591; 0.0409]) * ... % Via point 1 of vastus lateralis (from 0 to -69.32 degrees of knee flexion)
%         Segment(5).rScale,[1,1,ni]) + ... % In thigh
%         sqrt(sum((Mprod_array3(repmat(NV375,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV375,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV385,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end

% Gastrocnemius medialis
Model.Lmt(32,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV415,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV405,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV405,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV173,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV173,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV42,[1,1,n]),Segment(2).Q)).^2));
% ind = find(FE3 < -44.14);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(32,1,ind) = ...
%     sqrt(sum((Mprod_array3(repmat(NV405,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV173,[1,1,ni]),Segment(3).Q(:,:,ind))).^2)) + ...
%     sqrt(sum((Mprod_array3(repmat(NV173,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV42,[1,1,ni]),Segment(2).Q(:,:,ind))).^2));
% end

% Gastrocnemius lateralis
Model.Lmt(33,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV435,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV425,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV425,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV52,[1,1,n]),Segment(2).Q)).^2));
% ind = find(FE3 < -44.14);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(33,1,ind) = ...
%     sqrt(sum((Mprod_array3(repmat(NV425,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV183,[1,1,ni]),Segment(3).Q(:,:,ind))).^2)) + ...
%     sqrt(sum((Mprod_array3(repmat(NV183,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV52,[1,1,ni]),Segment(2).Q(:,:,ind))).^2));
% end

% Soleus
Model.Lmt(34,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV193,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV62,[1,1,n]),Segment(2).Q)).^2));

% Tibialis posterior
Model.Lmt(35,1,1:n) = ...
    repmat(norm([-0.0094; -0.1348; 0.0019] - ... % Origin of tibialis posterior
    [-0.0144;-0.4051;-0.0229]) * ... % Via point 1 of tibialis posterior
    Segment(3).rScale,[1,1,n]) + ... In shank
    sqrt(sum((Mprod_array3(repmat(NV203,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV72,[1,1,n]),Segment(2).Q)).^2)) + ...
    norm([0.04170000; 0.03340000; -0.02860000] - ... % Via point 2 of tibialis posterior
    [0.07720000; 0.01590000; -0.02810000]) * ... % Insertion of tibialis posterior
    Segment(3).rScale; % In foot

% Tibialis anterior
Model.Lmt(36,1,1:n) = ...
    repmat(norm([0.0179; -0.1624; 0.0115] - ... % Origin of tibialis anterior
    [0.0329;-0.3951;-0.0177]) * ... % Via point 1 of tibialis anterior
    Segment(3).rScale,[1,1,n]) + ... In shank
    sqrt(sum((Mprod_array3(repmat(NV283,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV92,[1,1,n]),Segment(2).Q)).^2));

% Peroneus brevis 
Model.Lmt(37,1,1:n) = ...
    repmat(norm([-0.0070; -0.2646; 0.0325] - ... % Origin of peroneus brevis
    [-0.0198; -0.4184; 0.0283]) *  ... % Via point 1 of peroneus brevis
    Segment(3).rScale + ... In shank
    norm([-0.0198; -0.4184; 0.0283] -  ... % Via point 1 of peroneus brevis
    [-0.0144;-0.4295; 0.0289]) * ... % Via point 2 of peroneus brevis
    Segment(3).rScale,[1,1,n]) + ... In shank
    sqrt(sum((Mprod_array3(repmat(NV223,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV92,[1,1,n]),Segment(2).Q)).^2)) + ...
    repmat(norm([0.04710000; 0.02700000; 0.02330000] - ... % Via point 4 of peroneus brevis
    [0.06770000; 0.02190000; 0.03430000]) * ... % Insertion of peroneus brevis
    Segment(3).rScale,[1,1,n]); % In foot

% Peroneus longus
Model.Lmt(38,1,1:n) = ...
    repmat(norm([0.0005; -0.1568; 0.0362] - ... % Origin of peroneus longus
    [-0.0207; -0.4205; 0.0286]) * ... % Via point 1 of peroneus longus
    Segment(3).rScale + ... In shank
    norm([-0.0207; -0.4205; 0.0286] - ... % Via point 1 of peroneus longus
    [-0.0162;-0.4319; 0.0289]) * ... % Via point 2 of peroneus longus
    Segment(3).rScale,[1,1,n]) + ... In shank
    sqrt(sum((Mprod_array3(repmat(NV233,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV102,[1,1,n]),Segment(2).Q)).^2)) + ...
    repmat(norm([0.04380000; 0.02300000; 0.02210000] - ... % Via point 3 of peroneus longus
    [0.06810000; 0.01060000; 0.02840000]) * ... % Via point 4 of peroneus longus
    Segment(3).rScale + ... In foot
    norm([0.06810000; 0.01060000; 0.02840000] - ... % Via point 4 of peroneus longus
    [0.08520000; 0.00690000; 0.01180000]) * ... % Via point 5 of peroneus longus
    Segment(3).rScale + ... In foot
    norm([0.08520000; 0.00690000; 0.01180000] - ... % Via point 5 of peroneus longus
    [0.12030000; 0.00850000; -0.01840000]) * ... % Insertion of peroneus longus
    Segment(3).rScale,[1,1,n]); % In foot

% Peroneus tertius
Model.Lmt(39,1,1:n) = ...
    repmat(norm([0.0010; -0.2804; 0.0231] - ... % Origin of peroneus tertius
    [0.0229;-0.4069; 0.0159]) * ... % Via point 1 of peroneus tertius
    Segment(3).rScale,[1,1,n]) + ... In shank
    sqrt(sum((Mprod_array3(repmat(NV243,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV112,[1,1,n]),Segment(2).Q)).^2));

% Extensor digitorum longus
Model.Lmt(40,1,1:n) = ...
    repmat(norm([0.0032; -0.1381; 0.0276] - ... % Origin of extensor digitorum longus
    [0.0289;-0.4007; 0.0072]) * ... % Via point 1 of extensor digitorum longus
    Segment(3).rScale,[1,1,n]) + ... In shank
    sqrt(sum((Mprod_array3(repmat(NV253,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV122,[1,1,n]),Segment(2).Q)).^2)) + ...
    repmat(norm([0.09220000; 0.03880000; -0.00010000] - ... % Via point 2 of extensor digitorum longus
    [0.16160000; 0.00550000; 0.01300000]) * ... % Via point 3 of extensor digitorum longus
    Segment(3).rScale + ... In foot
    norm([0.16160000; 0.00550000; 0.01300000] - ... % Via point 3 of extensor digitorum longus
    ([0.00030000; 0.00470000; 0.01530000]+[0.1788; -0.002; 0.00108])) * ... % Via point 4 of extensor digitorum longus
    Segment(3).rScale + ... In foot
    norm([0.00030000; 0.00470000; 0.01530000] - ... % Via point 4 of extensor digitorum longus
    [0.04430000; -0.00040000; 0.02500000]) * ... % Insertion of extensor digitorum longus
    Segment(3).rScale,[1,1,n]); % In foot

% Extensor hallucis longus
Model.Lmt(41,1,1:n) = ...
    repmat(norm([0.0012; -0.1767; 0.0228] - ... % Origin of extensor hallucis longus
    [0.0326;-0.3985;-0.0085]) * ... % Via point 1 of extensor hallucis longus
    Segment(3).rScale,[1,1,n]) + ... In shank
    sqrt(sum((Mprod_array3(repmat(NV263,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV132,[1,1,n]),Segment(2).Q)).^2)) + ...
    repmat(norm([0.09700000; 0.03890000; -0.02110000] - ... % Via point 2 of extensor hallucis longus
    [0.12930000; 0.03090000; -0.02570000]) * ... % Via point 3 of extensor hallucis longus
    Segment(3).rScale + ... In foot
    norm([0.12930000; 0.03090000; -0.02570000] - ... % Via point 3 of extensor hallucis longus
    [0.17340000; 0.01390000; -0.02800000]) * ... % Via point 4 of extensor hallucis longus
    Segment(3).rScale + ... In foot
    norm([0.17340000; 0.01390000; -0.02800000] - ... % Via point 4 of extensor hallucis longus
    ([0.02980000; 0.00410000; -0.02450000]+[0.1788; -0.002; 0.00108])) * ... % Via point 5 of extensor hallucis longus
    Segment(3).rScale + ... In foot
    norm([0.02980000; 0.00410000; -0.02450000] - ... % Via point 5 of extensor hallucis longus
    [0.05630000; 0.00340000; -0.01860000]) * ... % Insertion of extensor hallucis longus
    Segment(3).rScale,[1,1,n]); % In foot

% Flexor digitorum longus
Model.Lmt(42,1,1:n) = ...
    repmat(norm([-0.0083; -0.2046; -0.0018] - ... % Origin of flexor digitorum longus
    [-0.0154;-0.4051;-0.0196]) * ... % Via point 1 of flexor digitorum longus
    Segment(3).rScale,[1,1,n]) + ... In shank
    sqrt(sum((Mprod_array3(repmat(NV273,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV142,[1,1,n]),Segment(2).Q)).^2)) + ...
    repmat(norm([0.04360000; 0.03150000; -0.02800000] - ... % Via point 2 of flexor digitorum longus
    [0.07080000; 0.01760000; -0.02630000]) * ... % Via point 3 of flexor digitorum longus
    Segment(3).rScale + ... In foot
    norm([0.07080000; 0.01760000; -0.02630000] - ... % Via point 3 of flexor digitorum longus
    [0.16580000; -0.00810000; 0.01160000]) * ... % Via point 4 of flexor digitorum longus
    Segment(3).rScale + ... In foot
    norm([0.16580000; -0.00810000; 0.01160000] - ... % Via point 4 of flexor digitorum longus
    ([-0.00190000; -0.00780000; 0.01470000]+[0.1788; -0.002; 0.00108])) * ... % Via point 5 of flexor digitorum longus
    Segment(3).rScale + ... In foot
    norm([-0.00190000; -0.00780000; 0.01470000] - ... % Via point 5 of flexor digitorum longus
    [0.02850000; -0.00710000; 0.02150000]) * ... % Via point 6 of flexor digitorum longus
    Segment(3).rScale + ... In foot
    norm([0.02850000; -0.00710000; 0.02150000] - ... % Via point 6 of flexor digitorum longus
    [0.04410000; -0.00600000; 0.02420000]) * ... % Insertion of flexor digitorum longus
    Segment(3).rScale,[1,1,n]); % In foot

% Flexor hallucis longus
Model.Lmt(43,1,1:n) = ...
    repmat(norm([-0.0079; -0.2334; 0.0244] - ... % Origin of flexor hallucis longus
    [-0.0186;-0.4079;-0.0174]) * ... % Via point of flexor hallucis longus
    Segment(3).rScale,[1,1,n]) + ... In shank
    sqrt(sum((Mprod_array3(repmat(NV283,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV152,[1,1,n]),Segment(2).Q)).^2)) + ...
    repmat(norm([0.03740000; 0.02760000; -0.02410000] - ... % Via point 2 of flexor hallucis longus
    [0.10380000; 0.00680000; -0.02560000]) * ... % Via point 3 of flexor hallucis longus
    Segment(3).rScale + ... In foot
    norm([0.10380000; 0.00680000; -0.02560000] - ... % Via point 3 of flexor hallucis longus
    [0.17260000; -0.00530000; -0.02690000]) * ... % Via point 4 of flexor hallucis longus
    Segment(3).rScale + ... In foot
    norm([0.17260000; -0.00530000; -0.02690000] - ... % Via point 4 of flexor hallucis longus
    ([0.01550000; -0.00640000; -0.02650000]+[0.1788; -0.002; 0.00108])) * ... % Via point 5 of flexor hallucis longus
    Segment(3).rScale + ... In foot
    norm([0.01550000; -0.00640000; -0.02650000] - ... % Via point 5 of flexor hallucis longus
    [0.05620000; -0.01020000; -0.01810000]) * ... % Origin of flexor hallucis longus
    Segment(3).rScale,[1,1,n]); % In foot

